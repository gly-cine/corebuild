<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語学習サイト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムフォントとして日本語表示に適したInterを設定 */
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        /* 画面全体にフィットし、スクロールを発生させないためのスタイル */
        .h-screen-no-scroll { height: 100vh; overflow: hidden; }
        .word-button { transition: all 0.2s; }
        .word-button:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .selected { opacity: 0.5; pointer-events: none; }
        /* 音声先行モード用の強いぼかし */
        .blur-strong { filter: blur(8px); }
        
        /* 文法問題の選択肢のホバー効果 */
        .choice-button:not(:disabled):hover { 
            background-color: #f3f4f6; /* gray-100 */
            border-color: #4f46e5; /* primary-600 */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // スタイリッシュテーマのカラー定義
                        'primary': '#4f46e5', // Indigo-600
                        'secondary': '#10b981', // Emerald-500
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen-no-scroll flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl flex flex-col h-full md:h-5/6 overflow-hidden">

        <header id="app-header" class="p-6 bg-primary text-white rounded-t-xl shadow-lg flex flex-col md:flex-row justify-between items-center hidden">
            <h1 class="text-2xl font-bold tracking-tight mb-3 md:mb-0">海外旅行で便利なフレーズ</h1>
            
            <div class="flex flex-wrap justify-center items-center space-x-4 mt-3 md:mt-0">
                
                <div class="flex items-center space-x-2">
                    <label for="filter-mode-selector" class="text-sm font-medium">表示:</label>
                    <select id="filter-mode-selector" onchange="applyAllFilters()" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        <option value="ALL">全ての英文</option>
                        <option value="UNLEARNED">未学習のみ</option>
                        <option value="LEARNED">学習済のみ</option>
                    </select>
                </div>

                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                    <label for="mode-selector" class="text-sm font-medium">学習モード:</label>
                    <select id="mode-selector" onchange="changeMode(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        <option value="1">① 英文先行</option>
                        <option value="2">② 音声先行</option>
                        <option value="4">③ 文法問題</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                    <label for="grammar-type-selector" class="text-sm font-medium">文法類型:</label>
                    <select id="grammar-type-selector" onchange="filterByType(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        </select>
                </div>
            </div>
        </header>

        <main class="flex-grow p-6 flex flex-col space-y-4 overflow-y-auto">

            <div id="selection-screen" class="p-12 flex flex-col items-center justify-center h-full text-center">
                <h2 id="selection-title" class="text-3xl font-extrabold text-gray-800 mb-8">学習コンテンツを選択してください</h2>
                
                <div id="main-category-buttons" class="space-y-6 w-full max-w-md">
                    <button id="btn-travel" onclick="selectCategory('travel')" class="w-full py-4 bg-primary text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-200 transform hover:scale-[1.02]">
                        ✈️ 旅行用英語
                    </button>
                </div>
            </div>
            
            <div id="learning-screen" class="hidden flex-grow flex flex-col space-y-4">
                
                <div class="text-center text-sm text-gray-500 mb-4 flex justify-between items-center">
                    
                    <span id="progress-indicator" class="px-2 py-1 rounded-md text-gray-600 font-semibold"></span>

                    <div class="flex items-center space-x-2">
                        <label for="scene-filter" class="text-sm font-medium text-gray-600">使用場面:</label>
                        <select id="scene-filter" onchange="filterScenes(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary"></select>
                    </div>

                </div>
    
                <div id="english-display-card" class="bg-indigo-50 p-6 rounded-xl shadow-inner min-h-[100px] flex items-center justify-center transition-all duration-300">
                    <p id="english-text" class="text-xl md:text-2xl font-bold text-gray-800 text-center select-none">
                        </p>
                </div>
    
                <div id="translation-card" class="bg-white p-4 border border-gray-200 rounded-xl shadow min-h-[60px] transition-all duration-300 hidden flex flex-col">
                    <p class="text-sm font-semibold text-gray-600 mb-1">和訳</p>
                    <div class="flex-grow flex items-center justify-center">
                        <p id="japanese-text" class="text-lg text-gray-700 text-center w-full">
                            -
                        </p>
                    </div>
                </div>
                
                <div id="grammar-question-ui" class="hidden flex-col space-y-4 pt-4">

                    <p id="grammar-question-text" class="text-xl font-bold mb-4 text-gray-800 text-center px-4"></p>

                    <div id="grammar-choices" class="flex flex-col space-y-3 mx-auto w-full max-w-lg">
                        <button id="choice-A" onclick="checkGrammarAnswer('A')" class="choice-button py-3 px-4 rounded-lg text-lg text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                        <button id="choice-B" onclick="checkGrammarAnswer('B')" class="choice-button py-3 px-4 rounded-lg text-lg text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                        <button id="choice-C" onclick="checkGrammarAnswer('C')" class="choice-button py-3 px-4 rounded-lg text-lg text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                        <button id="choice-D" onclick="checkGrammarAnswer('D')" class="choice-button py-3 px-4 rounded-lg text-lg text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                    </div>

                    <div id="grammar-answer-explanation" class="hidden mt-6 p-4 rounded-xl shadow-xl bg-white border-2 border-green-500 max-w-xl mx-auto w-full">
                        <p class="font-bold text-green-700 mb-2 border-b border-green-200 pb-1">【正解】<span id="grammar-correct-answer" class="font-extrabold"></span></p>
                        <p class="font-bold text-gray-700 mt-3 mb-1">【解説】</p>
                        <p id="grammar-explanation-text" class="text-gray-600 text-base"></p>
                    </div>
                </div>

                <div id="message-box" class="text-center py-2 text-lg font-semibold hidden rounded-lg"></div>
            </div>

        </main>

        <footer id="app-footer" class="p-6 bg-gray-100 rounded-b-xl border-t border-gray-200 flex justify-between items-center flex-wrap hidden">
            <div class="flex space-x-2">
                <button onclick="navigate(-1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    &lt; 前の文
                </button>
                <button onclick="navigate(1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    次の文 &gt;
                </button>
            </div>
            
            <button onclick="showSelectionScreen()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium mt-4 md:mt-0">
                TOP画面
            </button>

            <div class="flex space-x-3 mt-4 md:mt-0">
                
                <button id="toggle-learned-btn" onclick="toggleLearnedStatus()" class="px-6 py-2 bg-secondary text-white font-bold rounded-lg hover:bg-emerald-600 transition-colors shadow-md flex items-center hidden">
                    ✓ 覚えた
                </button>
                
                <button id="toggle-translation-btn" onclick="toggleTranslation()" class="px-6 py-2 bg-primary text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-md hidden">
                    和訳を表示
                </button>

                <button id="play-audio-btn" onclick="playAudio()" class="px-6 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition-colors shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 108 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    音声再生
                </button>
            </div>
        </footer>

    </div>

<script>
    // --- グローバル変数と定数 ---
    let ALL_DB = []; // 読み込んだ全データ
    let DB = []; // 現在の学習データ (フィルタリング後)
    let currentMode = 1; // 1:英文先行, 2:音声先行, 4:文法問題 (デフォルトを1に変更)
    let currentSentenceIndex = 0;
    let isTranslationVisible = false; 
    let currentCategoryKey = ''; 
    const LEARNED_STATUS_KEY = 'learning_app_learned_status'; 
    
    let messageTimeoutId = null; 
    let currentGrammarType = 'ALL'; 

    // JSONパスと対応する音声フォルダを定義
    const CATEGORY_MAP = {
        'travel': { 
            jsonPath: './data/travel_sentences.json', 
            audioFolder: 'travel', 
            name: '旅行用英語',
            // 埋め込みデータ (添付ファイルの内容に基づき、文法問題データを含む)
            data: [
              { "id": "travel_sentences_00001", "en": "I'd like to check in for my flight to New York.", "ja": "ニューヨーク行きのフライトのチェックインをしたいです。", "year": null, "category_main": "空港", "category_sub": "チェックイン", "priority": "高", "grammar_question": "I'd like to ___ in for my flight to New York.", "grammar_answer": "D. check in", "grammar_choice_a": "A. check", "grammar_choice_b": "B. checking", "grammar_choice_c": "C. checked", "grammar_choice_d": "D. check in", "grammar_explanation": "「would like to＋動詞の原形」で『～したい』。句動詞はそのまま原形で使う。", "grammar_type": "成句" },
              { "id": "travel_sentences_00002", "en": "Can I have a window seat, please?", "ja": "窓側の席をお願いします。", "year": null, "category_main": "空港", "category_sub": "チェックイン", "priority": "中", "grammar_question": "Can I have a ___ seat, please?", "grammar_answer": "B. window", "grammar_choice_a": "A. windows", "grammar_choice_b": "B. window", "grammar_choice_c": "C. a window", "grammar_choice_d": "D. some window", "grammar_explanation": "「window seat」は「窓側の席」という複合名詞で、不可算名詞ではないため単数形で使う。", "grammar_type": "名詞" },
              { "id": "travel_sentences_00003", "en": "How many bags can I check in?", "ja": "預け荷物は何個までですか？", "year": null, "category_main": "空港", "category_sub": "チェックイン", "priority": "中", "grammar_question": "How ___ bags can I check in?", "grammar_answer": "B. many", "grammar_choice_a": "A. much", "grammar_choice_b": "B. many", "grammar_choice_c": "C. far", "grammar_choice_d": "D. often", "grammar_explanation": "「bags（バッグ）」は数えられる名詞（可算名詞）なので、「How many」で数を尋ねる。", "grammar_type": "数量表現" },
              { "id": "travel_sentences_00004", "en": "Do I need to take my laptop out?", "ja": "ノートパソコンを取り出す必要がありますか？", "year": null, "category_main": "空港", "category_sub": "セキュリティチェック", "priority": "中", "grammar_question": "Do I ___ to take my laptop out?", "grammar_answer": "A. need", "grammar_choice_a": "A. need", "grammar_choice_b": "B. must", "grammar_choice_c": "C. should", "grammar_choice_d": "D. have", "grammar_explanation": "「～する必要があるか？」と尋ねるには「need to」を使う。「Do I have to」も可能だが、選択肢に「have to」はないため「need」が正解。", "grammar_type": "助動詞" },
              { "id": "travel_sentences_00005", "en": "Is this allowed in carry-on luggage?", "ja": "これは機内持ち込みできますか？", "year": null, "category_main": "空港", "category_sub": "セキュリティチェック", "priority": "中", "grammar_question": "Is this ___ in carry-on luggage?", "grammar_answer": "D. allowed", "grammar_choice_a": "A. allow", "grammar_choice_b": "B. allowing", "grammar_choice_c": "C. allows", "grammar_choice_d": "D. allowed", "grammar_explanation": "「be allowed to...」または「be allowed in...」で「～が許可されている」という受動態。", "grammar_type": "受動態" },
              { "id": "travel_sentences_00006", "en": "Which gate is the flight to Los Angeles?", "ja": "ロサンゼルス行きのフライトはどのゲートですか？", "year": null, "category_main": "空港", "category_sub": "搭乗", "priority": "高", "grammar_question": "Which gate is the flight ___ Los Angeles?", "grammar_answer": "B. to", "grammar_choice_a": "A. in", "grammar_choice_b": "B. to", "grammar_choice_c": "C. at", "grammar_choice_d": "D. for", "grammar_explanation": "「the flight to [場所]」で「[場所]行きのフライト」という意味。", "grammar_type": "前置詞" },
              { "id": "travel_sentences_00007", "en": "When does boarding start?", "ja": "搭乗はいつ始まりますか？", "year": null, "category_main": "空港", "category_sub": "搭乗", "priority": "高", "grammar_question": "When ___ boarding start?", "grammar_answer": "B. does", "grammar_choice_a": "A. is", "grammar_choice_b": "B. does", "grammar_choice_c": "C. did", "grammar_choice_d": "D. do", "grammar_explanation": "「boarding」は動名詞だが、ここでは「搭乗（という行為）」を表す単数名詞として扱われるため、助動詞「does」を用いる。", "grammar_type": "時制" },
              { "id": "travel_sentences_00078", "en": "Where can I find this?", "ja": "これはどこにありますか？", "year": null, "category_main": "汎用", "category_sub": "道案内", "priority": "中", "grammar_question": "Where can I ___ this?", "grammar_answer": "B. find", "grammar_choice_a": "A. found", "grammar_choice_b": "B. find", "grammar_choice_c": "C. finding", "grammar_choice_d": "D. finds", "grammar_explanation": "助動詞「can」の後は動詞の原形。この文には文法問題として適切なデータがすべて揃っている。", "grammar_type": "助動詞" },
              { "id": "travel_sentences_00079", "en": "I’m sorry, I’m not from around here.", "ja": "すみません、私はこの辺の者ではありません。", "year": null, "category_main": "汎用", "category_sub": "会話", "priority": "低", "grammar_question": "I’m sorry, I’m not ___ around here.", "grammar_answer": "D. from", "grammar_choice_a": "A. at", "grammar_choice_b": "B. in", "grammar_choice_c": "C. of", "grammar_choice_d": "D. from", "grammar_explanation": "「be from」で「～の出身である」または「～から来た」という意味。この場合、「この辺りの者ではない」という意図。", "grammar_type": "前置詞" }
            ]
        },
    };

    // --- DOM要素の参照 ---
    const filterModeSelectorEl = document.getElementById('filter-mode-selector'); 
    const toggleLearnedBtn = document.getElementById('toggle-learned-btn'); 
    const modeSelectorEl = document.getElementById('mode-selector'); 
    const englishTextEl = document.getElementById('english-text');
    const japaneseTextEl = document.getElementById('japanese-text');
    const translationCardEl = document.getElementById('translation-card');
    const toggleTranslationBtn = document.getElementById('toggle-translation-btn');
    const messageBoxEl = document.getElementById('message-box');
    const selectionScreenEl = document.getElementById('selection-screen'); 
    const learningScreenEl = document.getElementById('learning-screen'); 
    const appHeaderEl = document.getElementById('app-header'); 
    const appFooterEl = document.getElementById('app-footer'); 
    const progressIndicatorEl = document.getElementById('progress-indicator'); 
    const sceneFilterEl = document.getElementById('scene-filter'); 

    // ★修正: 文法問題用のDOM要素の参照を修正/追加
    const grammarTypeSelectorEl = document.getElementById('grammar-type-selector'); // プルダウンに変更
    const grammarQuestionUiEl = document.getElementById('grammar-question-ui');
    const grammarQuestionTextEl = document.getElementById('grammar-question-text');
    const grammarAnswerExplanationEl = document.getElementById('grammar-answer-explanation');
    const grammarCorrectAnswerEl = document.getElementById('grammar-correct-answer');
    const grammarExplanationTextEl = document.getElementById('grammar-explanation-text');
    
    // --- Persistence (学習済ステータスの保存/読み込み) ---

    function loadLearnedStatus() {
        try {
            const stored = localStorage.getItem(LEARNED_STATUS_KEY);
            return stored ? JSON.parse(stored) : {};
        } catch (e) {
            console.error("Failed to load learned status from localStorage", e);
            return {};
        }
    }

    function saveLearnedStatus(statusMap) {
        try {
            localStorage.setItem(LEARNED_STATUS_KEY, JSON.stringify(statusMap));
        } catch (e) {
            console.error("Failed to save learned status to localStorage", e);
        }
    }

    // --- アプリ初期化 ---
    window.onload = function() {
        showSelectionScreen(); 
    };
    
    function showSelectionScreen() {
        selectionScreenEl.classList.remove('hidden');
        learningScreenEl.classList.add('hidden');
        appHeaderEl.classList.add('hidden');
        appFooterEl.classList.add('hidden');
        
        progressIndicatorEl.textContent = ''; 
        toggleLearnedBtn.classList.add('hidden');
        grammarQuestionUiEl.classList.add('hidden');
    }

    function selectCategory(category) {
        if (category === 'travel') {
            startLearning('travel');
            return;
        } 
    }
    
    async function startLearning(key) {
        const config = CATEGORY_MAP[key];
        if (!config) {
            showMessage('エラー: 不正なカテゴリが選択されました！', 'danger');
            return;
        }
        
        // UIの切り替え
        selectionScreenEl.classList.add('hidden');
        learningScreenEl.classList.remove('hidden');
        appHeaderEl.classList.remove('hidden');
        appFooterEl.classList.remove('hidden');
        document.getElementById('app-header').querySelector('h1').textContent = config.name;

        currentCategoryKey = key;
        
        // データの初期化とロード (今回は埋め込みデータを使用)
        const learnedStatusMap = loadLearnedStatus();
        ALL_DB = config.data.map(item => ({
            ...item,
            isLearned: !!learnedStatusMap[item.id]
        })); 

        if (ALL_DB.length === 0) {
            englishTextEl.textContent = `${config.name} のデータがありません。`;
            showMessage('JSONファイルにデータがありません。', 'danger');
            return;
        }
        
        // 場面フィルターを初期化
        setupSceneFilter(ALL_DB); 
        // 文法類型フィルターを初期化
        setupGrammarTypeFilter(ALL_DB);
        
        // モードをデフォルト（英文先行）に設定し、フィルターを適用
        modeSelectorEl.value = currentMode;
        applyAllFilters(); 
    }
    
    function setupSceneFilter(data) {
        const scenes = new Set(data.map(item => item.category_main).filter(c => c && c.trim() !== ''));
        const sortedScenes = Array.from(scenes).sort((a, b) => a.localeCompare(b, 'ja', { sensitivity: 'base' })); 
        
        sceneFilterEl.innerHTML = '';
        
        const allOption = document.createElement('option');
        allOption.value = 'ALL';
        allOption.textContent = '全ての使用場面';
        sceneFilterEl.appendChild(allOption);
        
        sortedScenes.forEach(scene => {
            const option = document.createElement('option');
            option.value = scene;
            option.textContent = scene;
            sceneFilterEl.appendChild(option);
        });
        
        sceneFilterEl.classList.remove('hidden');
    }

    /**
     * 文法類型フィルタープルダウンをセットアップする
     */
    function setupGrammarTypeFilter(data) {
        const grammarData = data.filter(item => item.grammar_type);
        const types = new Set(grammarData.map(item => item.grammar_type).filter(t => t && t.trim() !== ''));
        const sortedTypes = Array.from(types).sort((a, b) => a.localeCompare(b, 'ja', { sensitivity: 'base' })); 
        
        grammarTypeSelectorEl.innerHTML = ''; 

        // 1. 全て (ALL) オプションを追加
        const allOption = document.createElement('option');
        allOption.value = 'ALL';
        allOption.textContent = '全ての類型';
        grammarTypeSelectorEl.appendChild(allOption);

        // 2. 各類型オプションを追加
        sortedTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = type;
            grammarTypeSelectorEl.appendChild(option);
        });
        
        grammarTypeSelectorEl.value = currentGrammarType; // 初期選択状態を設定
    }

    function filterByType(type) {
        currentGrammarType = type;
        if (currentMode === 4) { // 文法問題モードの場合のみDBを再構築
            applyAllFilters();
        }
    }
    
    function applyAllFilters() {
        if (ALL_DB.length === 0) return;
        
        // 1. 場面フィルターの適用
        const scene = sceneFilterEl.value;
        let tempDB = (scene === 'ALL') 
            ? ALL_DB 
            : ALL_DB.filter(item => item.category_main === scene);
            
        // 2. 学習済フィルターの適用
        const learnedFilter = filterModeSelectorEl.value;
        if (learnedFilter === 'LEARNED') {
            tempDB = tempDB.filter(item => item.isLearned);
        } else if (learnedFilter === 'UNLEARNED') {
            tempDB = tempDB.filter(item => !item.isLearned);
        }
        
        // 3. モード固有のフィルターを適用
        if (currentMode === 4) { // 文法問題モード
            let grammarDB = tempDB.filter(item => item.grammar_question);
            if (currentGrammarType !== 'ALL') {
                grammarDB = grammarDB.filter(item => item.grammar_type === currentGrammarType);
            }
            DB = grammarDB;
        } else { // 英文先行/音声先行モード
            // 文法問題データのない項目も含む
            DB = tempDB;
        }

        if (DB.length === 0) {
             englishTextEl.textContent = '選択された条件に該当するデータがありません。';
             showMessage('データが見つかりませんでした。', 'danger');
             progressIndicatorEl.textContent = '0/0'; 
             toggleLearnedBtn.classList.add('hidden');
             // 英文を初期状態に戻す
             englishTextEl.classList.remove('italic', 'text-gray-400', 'blur-strong');
             translationCardEl.classList.add('hidden');
             return;
        }

        currentSentenceIndex = 0;
        loadSentence(currentSentenceIndex);
    }
    
    function filterScenes(scene) {
        applyAllFilters();
    }


    /**
     * モードを切り替える
     */
    function changeMode(mode) {
        // currentModeを更新し、UIをリセット
        currentMode = parseInt(mode, 10);
        modeSelectorEl.value = currentMode;
        isTranslationVisible = false; // モード切り替え時、和訳は非表示に戻す
        
        // 全てのモード固有UIをリセット
        translationCardEl.classList.add('hidden');
        englishTextEl.classList.remove('blur-strong', 'italic', 'text-gray-400');
        
        // 文法問題UIの表示/非表示を切り替え
        const isGrammarMode = currentMode === 4;
        grammarQuestionUiEl.classList.toggle('hidden', !isGrammarMode);
        
        // その他共通UIの表示/非表示を切り替え
        toggleLearnedBtn.classList.toggle('hidden', isGrammarMode);
        
        if (currentMode === 1) { // 英文先行
            toggleTranslationBtn.textContent = '和訳を表示';
            toggleTranslationBtn.classList.remove('hidden'); // ボタンを表示
        } else if (currentMode === 2) { // 音声先行
            toggleTranslationBtn.textContent = '英文・和訳を表示';
            toggleTranslationBtn.classList.remove('hidden'); // ボタンを表示
        } else if (currentMode === 4) { // 文法問題
             toggleTranslationBtn.classList.add('hidden'); // 文法モードでは非表示
        }
        
        // モードに合わせてDBを再構築（文法問題は文法問題データがあるものに絞るため）
        applyAllFilters(); 
    }

    /**
     * 現在の文のデータをUIに読み込む
     */
    function loadSentence(index) {
        if (DB.length === 0) {
             progressIndicatorEl.textContent = '0/0';
             return; 
        }
        
        currentSentenceIndex = (index + DB.length) % DB.length;
        const data = DB[currentSentenceIndex];

        // 進捗状況を更新
        progressIndicatorEl.textContent = `${currentSentenceIndex + 1}/${DB.length}`;

        // 英文/和訳表示エリアのクリアとリセット
        englishTextEl.classList.remove('italic', 'text-gray-400', 'blur-strong');
        translationCardEl.classList.add('hidden');
        isTranslationVisible = false;

        // モードによる表示の分岐
        if (currentMode === 4) {
            setupGrammarMode(data);
        } else {
            // 英文先行/音声先行モード (③ 英文・和訳の表示修正)
            
            // 英文を一旦全て表示
            englishTextEl.textContent = data.en.replace(/\n/g, '<br>');
            japaneseTextEl.textContent = data.ja.replace(/\n/g, '<br>');

            // 音声先行モードの場合は英文をぼかす
            if (currentMode === 2) {
                englishTextEl.classList.add('blur-strong');
            }
            
            // 和訳の表示状態はボタンに依存
            updateTranslationVisibility(); 

            // 学習済ボタンのUIを更新
            updateLearnedButtonUI(data.isLearned);
        }
        
        hideMessage();
    }
    
    // --- モード 4 (文法問題) のロジック ---

    function setupGrammarMode(data) {
        if (!data.grammar_question) {
            grammarQuestionTextEl.textContent = 'この文には文法問題がありません。次の文へ進んでください。';
            // 英文カードを空にし、メッセージを表示
            englishTextEl.textContent = '【文法問題モード】問題データがありません。';
            englishTextEl.classList.add('italic', 'text-gray-400');
            showMessage('問題データがありません', 'danger');
            return;
        }

        // 1. UIを初期状態に戻す
        grammarAnswerExplanationEl.classList.add('hidden');
        
        // 2. 選択肢ボタンを有効化・リセット (④ 選択肢の表示修正)
        document.querySelectorAll('.choice-button').forEach(button => {
            button.disabled = false;
            button.classList.remove('bg-red-400', 'text-white', 'bg-green-400', 'bg-green-200', 'text-green-800');
            button.classList.add('bg-gray-100', 'border-gray-300');
        });
        
        // 3. 問題文と選択肢を表示 (④ 選択肢の表示修正: 'A. 'などを削除してデータのみ表示)
        grammarQuestionTextEl.textContent = data.grammar_question; 
        document.getElementById('choice-A').textContent = `A. ${data.grammar_choice_a.substring(3).trim()}`;
        document.getElementById('choice-B').textContent = `B. ${data.grammar_choice_b.substring(3).trim()}`;
        document.getElementById('choice-C').textContent = `C. ${data.grammar_choice_c.substring(3).trim()}`;
        document.getElementById('choice-D').textContent = `D. ${data.grammar_choice_d.substring(3).trim()}`;
        
        // 4. 英文・和訳表示エリアは非表示に
        englishTextEl.textContent = '【文法問題モード】正しい選択肢を選んでください。';
        englishTextEl.classList.add('italic', 'text-gray-400');
    }

    function checkGrammarAnswer(choiceLetter) {
        const currentQuestion = DB[currentSentenceIndex];
        // 選択肢の文字と、問題データ内の選択肢の内容を結合して、完全な解答形式と比較
        const userAnswerText = currentQuestion['grammar_choice_' + choiceLetter.toLowerCase()].substring(3).trim();
        const userAnswer = `${choiceLetter}. ${userAnswerText}`;
        const correctAnswer = currentQuestion.grammar_answer;
        
        const isCorrect = userAnswer === correctAnswer;

        // 1. 全選択肢を無効化
        document.querySelectorAll('.choice-button').forEach(button => {
            button.disabled = true;
        });

        // 2. 選択したボタンのスタイル変更
        const selectedButton = document.getElementById(`choice-${choiceLetter}`);
        selectedButton.classList.remove('bg-gray-100', 'border-gray-300');

        if (isCorrect) {
            showMessage('正解です！', 'secondary');
            selectedButton.classList.add('bg-secondary', 'text-white');
        } else {
            showMessage('残念！不正解です。', 'danger');
            selectedButton.classList.add('bg-danger', 'text-white');
            
            // 正解のボタンをハイライト
            const correctChoiceLetter = correctAnswer.substring(0, 1);
            const correctButton = document.getElementById(`choice-${correctChoiceLetter}`);
            correctButton.classList.remove('bg-gray-100', 'border-gray-300');
            correctButton.classList.add('bg-green-200', 'text-green-800'); 
        }
        
        // 3. 解答と解説を表示
        grammarCorrectAnswerEl.textContent = correctAnswer;
        grammarExplanationTextEl.textContent = currentQuestion.grammar_explanation;
        grammarAnswerExplanationEl.classList.remove('hidden');

        // 4. 元の英文と和訳を表示 (学習を促すため)
        englishTextEl.textContent = currentQuestion.en;
        englishTextEl.classList.remove('italic', 'text-gray-400');
        japaneseTextEl.textContent = currentQuestion.ja;
        translationCardEl.classList.remove('hidden');
    }
    
    // --- 共通ロジック ---

    function toggleTranslation() {
        if (currentMode === 4) return;
        isTranslationVisible = !isTranslationVisible;
        updateTranslationVisibility();
    }
    
    // ③ 和訳/英文の表示ロジックの修正
    function updateTranslationVisibility() {
        if (currentMode === 4) return;
        
        if (isTranslationVisible) {
            translationCardEl.classList.remove('hidden');
            toggleTranslationBtn.textContent = (currentMode === 2) ? '英文・和訳を非表示' : '和訳を非表示';
            // 英文をはっきり表示
            englishTextEl.classList.remove('blur-strong'); 
        } else {
            translationCardEl.classList.add('hidden');
            toggleTranslationBtn.textContent = (currentMode === 2) ? '英文・和訳を表示' : '和訳を表示';
            // 音声先行モードの場合は英文を強くぼかす
            if (currentMode === 2) {
                 englishTextEl.classList.add('blur-strong'); 
            } else {
                englishTextEl.classList.remove('blur-strong');
            }
        }
        toggleTranslationBtn.classList.remove('hidden'); // ④ ボタンの表示
    }

    function toggleLearnedStatus() {
        if (DB.length === 0 || currentMode === 4) return; 

        const currentData = DB[currentSentenceIndex];
        const sentenceId = currentData.id;
        
        currentData.isLearned = !currentData.isLearned; 
        
        const learnedStatusMap = loadLearnedStatus();
        if (currentData.isLearned) {
            learnedStatusMap[sentenceId] = true;
            showMessage("「学習済」にチェックしました！", 'secondary');
        } else {
            delete learnedStatusMap[sentenceId]; 
            showMessage("「未学習」に戻しました。", 'gray');
        }
        saveLearnedStatus(learnedStatusMap);

        updateLearnedButtonUI(currentData.isLearned);
        
        const learnedFilter = filterModeSelectorEl.value;
        if ((learnedFilter === 'LEARNED' && !currentData.isLearned) || 
            (learnedFilter === 'UNLEARNED' && currentData.isLearned)) {
            
            applyAllFilters();
        }
    }
    
    function updateLearnedButtonUI(isLearned) {
        if (DB.length === 0 || currentMode === 4) {
             toggleLearnedBtn.classList.add('hidden');
             return;
        }
        
        if (isLearned) {
            toggleLearnedBtn.textContent = '✅ 解除'; 
            toggleLearnedBtn.classList.remove('bg-secondary', 'hover:bg-emerald-600');
            toggleLearnedBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        } else {
            toggleLearnedBtn.textContent = '✓ 覚えた'; 
            toggleLearnedBtn.classList.add('bg-secondary', 'hover:bg-emerald-600');
            toggleLearnedBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
        }
        toggleLearnedBtn.classList.remove('hidden');
    }

    function playAudio() {
        if (DB.length === 0 || !currentCategoryKey) return;
        
        const data = DB[currentSentenceIndex];
        const config = CATEGORY_MAP[currentCategoryKey];
        
        if (!config || !config.audioFolder) {
             showMessage("エラー: 音声フォルダ設定がありません。", 'danger');
             return;
        }

        const audioPath = `./audio/${config.audioFolder}/${data.id}.mp3`;
        
        const audio = new Audio(audioPath);
        audio.play().catch(e => {
            console.error("音声ファイルの再生に失敗しました。ファイルパスを確認してください: ", audioPath, e);
            showMessage("音声ファイルの読み込みまたは再生に失敗しました。パスを確認してください。", 'danger');
        });

        if (currentMode === 2 && !isTranslationVisible) {
             showMessage("音声が再生されました。英文の構成を考えましょう。", 'secondary');
        } else if (currentMode === 4) {
             showMessage("問題文の音声が再生されました。", 'primary');
        }
    }

    function navigate(direction) {
        if (DB.length === 0) return;
        let newIndex = currentSentenceIndex + direction;
        if (newIndex < 0) newIndex = DB.length - 1;
        
        isTranslationVisible = false; 
        loadSentence(newIndex);
    }
    
    /**
     * メッセージボックスを表示し、3秒後に非表示にする
     */
    function showMessage(text, type) {
        if (messageTimeoutId) {
            clearTimeout(messageTimeoutId);
        }
        
        messageBoxEl.textContent = text;
        messageBoxEl.className = `text-center py-2 px-4 text-lg font-semibold rounded-lg shadow-sm mt-4`;
        
        let bgColor, textColor;
        switch (type) {
            case 'secondary': bgColor = 'bg-emerald-200'; textColor = 'text-emerald-800'; break; // Secondaryカラー (Emerald)
            case 'danger': bgColor = 'bg-red-200'; textColor = 'text-red-800'; break;
            case 'primary': bgColor = 'bg-indigo-200'; textColor = 'text-indigo-800'; break; // Primaryカラー (Indigo)
            case 'gray': bgColor = 'bg-gray-200'; textColor = 'text-gray-800'; break;
            default: bgColor = 'bg-yellow-200'; textColor = 'text-yellow-800'; break;
        }
        messageBoxEl.classList.add(bgColor, textColor);
        messageBoxEl.classList.remove('hidden');
        
        // 3秒後に非表示にするタイマーを設定
        messageTimeoutId = setTimeout(hideMessage, 3000); 
    }

    function hideMessage() {
        messageBoxEl.classList.add('hidden');
        messageTimeoutId = null;
    }

</script>
</body>
</html>