<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語学習サイト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムフォントとして日本語表示に適したInterを設定 */
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        /* 画面全体にフィットし、スクロールを発生させないためのスタイル */
        .h-screen-no-scroll { height: 100vh; overflow: hidden; }
        .word-button { transition: all 0.2s; }
        .word-button:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .selected { opacity: 0.5; pointer-events: none; }
        /* ③ 音声先行モード用の強いぼかし */
        .blur-strong { filter: blur(8px); }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#10b981',
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen-no-scroll flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl flex flex-col h-full md:h-5/6 overflow-hidden">

        <header id="app-header" class="p-6 bg-primary text-white rounded-t-xl shadow-lg flex flex-col md:flex-row justify-between items-center hidden">
            <h1 class="text-2xl font-bold tracking-tight">海外旅行で便利なフレーズ</h1>
            
            <div class="flex items-center space-x-2 mt-3 md:mt-0">
                <label for="mode-selector" class="text-sm font-medium">学習モード:</label>
                <select id="mode-selector" onchange="changeMode(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="1">① 英文先行</option>
                    <option value="2">② 音声先行</option>
                    <option value="3">③ 並べ替え</option>
                </select>
            </div>
        </header>

        <main class="flex-grow p-6 flex flex-col space-y-4 overflow-y-auto">

            <div id="selection-screen" class="p-12 flex flex-col items-center justify-center h-full text-center">
                <h2 id="selection-title" class="text-3xl font-extrabold text-gray-800 mb-8">学習コンテンツを選択してください</h2>
                
                <div id="main-category-buttons" class="space-y-6 w-full max-w-md">
                    <button id="btn-travel" onclick="selectCategory('travel')" class="w-full py-4 bg-yellow-500 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-yellow-600 transition-colors duration-200 transform hover:scale-[1.02]">
                        ✈️ 旅行用英語
                    </button>
                </div>
                
                <div id="common-test-sub-group" class="w-full max-w-md hidden">
                    <h2 id="common-test-sub-title" class="text-3xl font-extrabold text-gray-800 mb-4">共通テスト：学習内容を選択</h2>
                    <div id="common-test-sub">...</div>
                </div>
                <div id="single-category-transition" class="mt-8 pt-6 w-full max-w-md hidden">...</div>
            </div>
            
            <div id="learning-screen" class="hidden flex-grow flex flex-col space-y-4">
                
                <div class="text-center text-sm text-gray-500 mb-4 flex justify-between items-center">
                    
                    <span id="progress-indicator" class="px-2 py-1 rounded-md text-gray-600 font-semibold"></span>

                    <div class="flex items-center space-x-2">
                        <label for="scene-filter" class="text-sm font-medium text-gray-600">使用場面:</label>
                        <select id="scene-filter" onchange="filterScenes(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-indigo-500 focus:border-indigo-500"></select>
                    </div>

                </div>
    
                <div id="english-display-card" class="bg-indigo-50 p-6 rounded-xl shadow-inner min-h-[100px] flex items-center justify-center transition-all duration-300">
                    <p id="english-text" class="text-xl md:text-2xl font-bold text-gray-800 text-center select-none">
                        学習モードを選択してください
                    </p>
                </div>
    
                <div id="translation-card" class="bg-white p-4 border border-gray-200 rounded-xl shadow min-h-[60px] transition-all duration-300 hidden flex flex-col justify-center">
                    <p class="text-sm font-semibold text-gray-600 mb-1">和訳</p>
                    <p id="japanese-text" class="text-lg text-gray-700 text-center">
                        -
                    </p>
                </div>
    
                <div id="scramble-ui" class="space-y-4 hidden">
                    <div class="p-4 bg-yellow-100 rounded-xl border-dashed border-2 border-yellow-300 min-h-[80px]">
                        <p class="text-sm font-semibold text-yellow-700 mb-1">解答構築エリア</p>
                        <div id="answer-area" class="flex flex-wrap gap-2">
                            </div>
                    </div>
    
                    <div class="p-4 bg-white rounded-xl shadow-md border-t border-gray-200">
                        <p class="text-sm font-semibold text-gray-600 mb-2">単語を選択して正しい英文を完成させよう</p>
                        <div id="scrambled-words-area" class="flex flex-wrap gap-2">
                            </div>
                    </div>
    
                    <div class="flex justify-center space-x-4 pt-2">
                        <button id="check-answer-btn" onclick="checkScrambledAnswer()" class="px-6 py-2 bg-secondary text-white font-bold rounded-lg hover:bg-green-600 transition-colors shadow-md hidden">
                            解答チェック
                        </button>
                        <button id="reset-scramble-btn" onclick="resetScramble()" class="px-6 py-2 bg-gray-500 text-white font-bold rounded-lg hover:bg-gray-600 transition-colors shadow-md hidden">
                            リセット
                        </button>
                    </div>
                </div>
    
                <div id="message-box" class="text-center py-2 text-lg font-semibold hidden rounded-lg"></div>
            </div>

        </main>

        <footer id="app-footer" class="p-6 bg-gray-100 rounded-b-xl border-t border-gray-200 flex justify-between items-center flex-wrap hidden">
            <div class="flex space-x-2">
                <button onclick="navigate(-1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    &lt; 前の文
                </button>
                <button onclick="navigate(1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    次の文 &gt;
                </button>
            </div>
            
            <button onclick="showSelectionScreen()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                TOP画面
            </button>

            <div class="flex space-x-3 mt-4 md:mt-0">
                <button id="toggle-translation-btn" onclick="toggleTranslation()" class="px-6 py-2 bg-indigo-500 text-white font-bold rounded-lg hover:bg-indigo-600 transition-colors shadow-md hidden">
                    和訳を表示
                </button>

                <button id="play-audio-btn" onclick="playAudio()" class="px-6 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition-colors shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 108 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    音声再生
                </button>
            </div>
        </footer>

    </div>

<script>
    // --- グローバル変数と定数 ---
    let ALL_DB = []; // 読み込んだ全データ
    let DB = []; // 現在の学習データ (フィルタリング後)
    let currentMode = 1;
    let currentSentenceIndex = 0;
    let isTranslationVisible = false; // 和訳表示の状態を維持
    let correctWords = []; 
    let scrambledWords = []; 
    let answerSequence = []; 
    let currentCategoryKey = ''; 

    // JSONパスと対応する音声フォルダを定義
    const CATEGORY_MAP = {
        'travel': { 
            jsonPath: './data/travel_sentences.json', 
            audioFolder: 'travel', 
            name: '旅行用英語'
        },
        // 他のカテゴリは省略
    };

    // --- DOM要素の参照 ---
    const modeSelectorEl = document.getElementById('mode-selector'); 
    const englishTextEl = document.getElementById('english-text');
    const japaneseTextEl = document.getElementById('japanese-text');
    const translationCardEl = document.getElementById('translation-card');
    const toggleTranslationBtn = document.getElementById('toggle-translation-btn');
    const scrambledWordsAreaEl = document.getElementById('scrambled-words-area');
    const answerAreaEl = document.getElementById('answer-area');
    const scrambleUiEl = document.getElementById('scramble-ui');
    const messageBoxEl = document.getElementById('message-box');
    const checkAnswerBtn = document.getElementById('check-answer-btn');
    const resetScrambleBtn = document.getElementById('reset-scramble-btn');
    const selectionScreenEl = document.getElementById('selection-screen'); 
    const learningScreenEl = document.getElementById('learning-screen'); 
    const commonTestSubGroupEl = document.getElementById('common-test-sub-group'); 
    const appHeaderEl = document.getElementById('app-header'); 
    const appFooterEl = document.getElementById('app-footer'); 
    const progressIndicatorEl = document.getElementById('progress-indicator'); 
    const selectionTitleEl = document.getElementById('selection-title');
    const mainCategoryButtonsEl = document.getElementById('main-category-buttons');
    const singleCategoryTransitionEl = document.getElementById('single-category-transition');
    const sceneFilterEl = document.getElementById('scene-filter'); 

    // --- アプリ初期化 ---
    window.onload = function() {
        showSelectionScreen(); 
    };
    
    /**
     * カテゴリ選択画面を表示し、学習画面を非表示にする
     */
    function showSelectionScreen() {
        selectionScreenEl.classList.remove('hidden');
        learningScreenEl.classList.add('hidden');
        appHeaderEl.classList.add('hidden');
        appFooterEl.classList.add('hidden');
        
        mainCategoryButtonsEl.classList.remove('hidden');
        commonTestSubGroupEl.classList.add('hidden'); 
        singleCategoryTransitionEl.classList.add('hidden');
        
        selectionTitleEl.textContent = '学習コンテンツを選択してください'; 
        selectionTitleEl.classList.remove('hidden'); 
        // 進捗表示をリセット
        progressIndicatorEl.textContent = ''; 
    }

    /**
     * カテゴリボタンが押されたときの処理
     */
    function selectCategory(category) {
        if (category === 'travel') {
            startLearning('travel');
            return;
        } 
    }
    
    /**
     * 学習を開始し、DBをロードする
     */
    async function startLearning(key) {
        const config = CATEGORY_MAP[key];
        if (!config) {
            showMessage('エラー: 不正なカテゴリが選択されました。', 'danger');
            return;
        }
        
        // UIの切り替え
        selectionScreenEl.classList.add('hidden');
        learningScreenEl.classList.remove('hidden');
        appHeaderEl.classList.remove('hidden');
        appFooterEl.classList.remove('hidden');

        currentCategoryKey = key;
        
        try {
            englishTextEl.textContent = `データの読み込み中です...`;
            
            // provided_json_content には添付ファイルの内容を想定
            // NOTE: ここで実際のファイル内容をシミュレーションします
            const provided_json_content = [
              { "id": "travel_sentences_00001", "en": "I'd like to check in for my flight to New York.", "ja": "ニューヨーク行きのフライトのチェックインをしたいです。", "year": null, "category_main": "空港", "category_sub": "チェックイン", "priority": "高" },
              { "id": "travel_sentences_00002", "en": "Can I have a window seat, please?", "ja": "窓側の席をお願いします。", "year": null, "category_main": "空港", "category_sub": "チェックイン", "priority": "中" },
              { "id": "travel_sentences_00003", "en": "How many bags can I check in?", "ja": "預け荷物は何個までですか？", "year": null, "category_main": "空港", "category_sub": "チェックイン", "priority": "中" },
              { "id": "travel_sentences_00004", "en": "Do I need to take my laptop out?", "ja": "ノートパソコンを取り出す必要がありますか？", "year": null, "category_main": "空港", "category_sub": "セキュリティチェック", "priority": "中" },
              { "id": "travel_sentences_00005", "en": "Is this allowed in carry-on luggage?", "ja": "これは機内持ち込みできますか？", "year": null, "category_main": "空港", "category_sub": "セキュリティチェック", "priority": "中" },
              { "id": "travel_sentences_00006", "en": "Which gate is the flight to Los Angeles?", "ja": "ロサンゼルス行きのフライトはどのゲートですか？", "year": null, "category_main": "空港", "category_sub": "搭乗", "priority": "高" },
              { "id": "travel_sentences_00007", "en": "When does boarding start?", "ja": "搭乗はいつ始まりますか？", "year": null, "category_main": "空港", "category_sub": "搭乗", "priority": "高" },
              { "id": "travel_sentences_00008", "en": "Where is the transfer desk?", "ja": "乗り継ぎカウンターはどこですか？", "year": null, "category_main": "空港", "category_sub": "乗り継ぎ", "priority": "低" },
              { "id": "travel_sentences_00009", "en": "I’m here for sightseeing.", "ja": "観光で来ました。", "year": null, "category_main": "空港", "category_sub": "出入国審査", "priority": "高" },
              { "id": "travel_sentences_00010", "en": "My flight was delayed. What should I do?", "ja": "フライトが遅れたのですが、どうすればいいですか？", "year": null, "category_main": "空港", "category_sub": "トラブル", "priority": "中" },
              { "id": "travel_sentences_00011", "en": "How do I get to the train station?", "ja": "駅へはどう行けばいいですか？", "year": null, "category_main": "移動", "category_sub": "徒歩", "priority": "高" },
              { "id": "travel_sentences_00012", "en": "Could you take me to the airport, please?", "ja": "空港までお願いします。", "year": null, "category_main": "移動", "category_sub": "タクシー", "priority": "高" },
              { "id": "travel_sentences_00013", "en": "How much is the fare to downtown?", "ja": "中心街までの運賃はいくらですか？", "year": null, "category_main": "移動", "category_sub": "タクシー", "priority": "高" },
              { "id": "travel_sentences_00014", "en": "Where can I buy a bus ticket?", "ja": "バスのチケットはどこで買えますか？", "year": null, "category_main": "移動", "category_sub": "バス", "priority": "中" },
              { "id": "travel_sentences_00015", "en": "Does this bus go to the city center?", "ja": "このバスは市の中心部に行きますか？", "year": null, "category_main": "移動", "category_sub": "バス", "priority": "高" },
              { "id": "travel_sentences_00016", "en": "Which platform does the train leave from?", "ja": "その電車はどのホームから出ますか？", "year": null, "category_main": "移動", "category_sub": "電車", "priority": "中" },
              { "id": "travel_sentences_00017", "en": "How long does it take to get there?", "ja": "そこまでどのくらい時間がかかりますか？", "year": null, "category_main": "移動", "category_sub": "全般", "priority": "中" },
              { "id": "travel_sentences_00018", "en": "Could you drop me off here, please?", "ja": "ここで降ろしてもらえますか？", "year": null, "category_main": "移動", "category_sub": "タクシー", "priority": "中" },
              { "id": "travel_sentences_00019", "en": "Is it within walking distance?", "ja": "歩いて行ける距離ですか？", "year": null, "category_main": "移動", "category_sub": "徒歩", "priority": "低" },
              { "id": "travel_sentences_00020", "en": "I think I’m lost. Can you help me?", "ja": "道に迷いました。助けてもらえますか？", "year": null, "category_main": "移動", "category_sub": "徒歩", "priority": "高" },
              { "id": "travel_sentences_00021", "en": "I have a reservation under the name of Tanaka.", "ja": "田中の名前で予約しています。", "year": null, "category_main": "ホテル", "category_sub": "チェックイン", "priority": "高" },
              { "id": "travel_sentences_00022", "en": "Could I have your ID and credit card, please?", "ja": "身分証明書とクレジットカードをお願いします。（※ホテル側の質問例）", "year": null, "category_main": "ホテル", "category_sub": "チェックイン", "priority": "中" },
              { "id": "travel_sentences_00023", "en": "What time is check-out?", "ja": "チェックアウトは何時ですか？", "year": null, "category_main": "ホテル", "category_sub": "チェックイン", "priority": "高" },
              { "id": "travel_sentences_00024", "en": "Could I have a late check-out, please?", "ja": "レイトチェックアウトをお願いできますか？", "year": null, "category_main": "ホテル", "category_sub": "チェックアウト", "priority": "中" },
              { "id": "travel_sentences_00025", "en": "Is breakfast included?", "ja": "朝食は含まれていますか？", "year": null, "category_main": "ホテル", "category_sub": "サービス", "priority": "高" },
              { "id": "travel_sentences_00026", "en": "Could you bring some extra towels, please?", "ja": "タオルをもう少し持ってきてもらえますか？", "year": null, "category_main": "ホテル", "category_sub": "サービス", "priority": "中" },
              { "id": "travel_sentences_00027", "en": "The air conditioner isn’t working.", "ja": "エアコンが動きません。", "year": null, "category_main": "ホテル", "category_sub": "トラブル", "priority": "中" },
              { "id": "travel_sentences_00028", "en": "Where is the nearest convenience store?", "ja": "一番近いコンビニはどこですか？", "year": null, "category_main": "ホテル", "category_sub": "周辺情報", "priority": "低" },
              { "id": "travel_sentences_00029", "en": "I’d like to leave my luggage here until this afternoon.", "ja": "午後まで荷物を預かってもらえますか？", "year": null, "category_main": "ホテル", "category_sub": "サービス", "priority": "高" },
              { "id": "travel_sentences_00030", "en": "Could you call a taxi for me, please?", "ja": "タクシーを呼んでもらえますか？", "year": null, "category_main": "ホテル", "category_sub": "サービス", "priority": "高" },
              { "id": "travel_sentences_00031", "en": "Could you take a picture of me, please?", "ja": "写真を撮ってもらえますか？", "year": null, "category_main": "観光", "category_sub": "観光地", "priority": "高" },
              { "id": "travel_sentences_00032", "en": "What time does the museum open?", "ja": "博物館は何時に開きますか？", "year": null, "category_main": "観光", "category_sub": "施設", "priority": "高" },
              { "id": "travel_sentences_00033", "en": "How much is the entrance fee?", "ja": "入場料はいくらですか？", "year": null, "category_main": "観光", "category_sub": "施設", "priority": "高" },
              { "id": "travel_sentences_00034", "en": "Is there a guided tour available?", "ja": "ガイドツアーはありますか？", "year": null, "category_main": "観光", "category_sub": "観光ツアー", "priority": "中" },
              { "id": "travel_sentences_00035", "en": "Where can I buy tickets for the boat cruise?", "ja": "ボートクルーズのチケットはどこで買えますか？", "year": null, "category_main": "観光", "category_sub": "アクティビティ", "priority": "中" },
              { "id": "travel_sentences_00036", "en": "How long does the tour take?", "ja": "ツアーはどのくらい時間がかかりますか？", "year": null, "category_main": "観光", "category_sub": "観光ツアー", "priority": "中" },
              { "id": "travel_sentences_00037", "en": "Are there any famous restaurants around here?", "ja": "この近くに有名なレストランはありますか？", "year": null, "category_main": "観光", "category_sub": "周辺情報", "priority": "中" },
              { "id": "travel_sentences_00038", "en": "Can I get there on foot?", "ja": "そこへは歩いて行けますか？", "year": null, "category_main": "観光", "category_sub": "道案内", "priority": "低" },
              { "id": "travel_sentences_00039", "en": "Where is the nearest restroom?", "ja": "一番近いトイレはどこですか？", "year": null, "category_main": "観光", "category_sub": "周辺情報", "priority": "高" },
              { "id": "travel_sentences_00040", "en": "What’s the best way to get to the city center?", "ja": "市の中心部へ行く一番良い方法は何ですか？", "year": null, "category_main": "観光", "category_sub": "道案内", "priority": "高" },
              { "id": "travel_sentences_00041", "en": "Table for two, please.", "ja": "2人用の席をお願いします。", "year": null, "category_main": "食事", "category_sub": "入店・案内", "priority": "高" },
              { "id": "travel_sentences_00042", "en": "Could we see the menu, please?", "ja": "メニューを見せてもらえますか？", "year": null, "category_main": "食事", "category_sub": "注文前", "priority": "高" },
              { "id": "travel_sentences_00043", "en": "What do you recommend?", "ja": "おすすめは何ですか？", "year": null, "category_main": "食事", "category_sub": "注文前", "priority": "中" },
              { "id": "travel_sentences_00044", "en": "I’ll have this one, please.", "ja": "これをお願いします。", "year": null, "category_main": "食事", "category_sub": "注文", "priority": "高" },
              { "id": "travel_sentences_00045", "en": "Could I get some water, please?", "ja": "お水をいただけますか？", "year": null, "category_main": "食事", "category_sub": "注文", "priority": "高" },
              { "id": "travel_sentences_00046", "en": "Does this dish contain nuts or seafood?", "ja": "この料理にはナッツやシーフードが入っていますか？", "year": null, "category_main": "食事", "category_sub": "注文前", "priority": "中" },
              { "id": "travel_sentences_00047", "en": "Could we have the bill, please?", "ja": "お会計をお願いします。", "year": null, "category_main": "食事", "category_sub": "会計", "priority": "高" },
              { "id": "travel_sentences_00048", "en": "Is service charge included?", "ja": "サービス料は含まれていますか？", "year": null, "category_main": "食事", "category_sub": "会計", "priority": "中" },
              { "id": "travel_sentences_00049", "en": "Could you pack this to go?", "ja": "これを持ち帰りにしてもらえますか？", "year": null, "category_main": "食事", "category_sub": "持ち帰り", "priority": "中" },
              { "id": "travel_sentences_00050", "en": "Everything was delicious, thank you!", "ja": "すべてとても美味しかったです、ありがとうございました！", "year": null, "category_main": "食事", "category_sub": "その他", "priority": "低" },
              { "id": "travel_sentences_00051", "en": "How much is this?", "ja": "これはいくらですか？", "year": null, "category_main": "買い物", "category_sub": "価格", "priority": "高" },
              { "id": "travel_sentences_00052", "en": "Can I try this on?", "ja": "試着してもいいですか？", "year": null, "category_main": "買い物", "category_sub": "衣料品", "priority": "高" },
              { "id": "travel_sentences_00053", "en": "Do you have this in a different size?", "ja": "これの別のサイズはありますか？", "year": null, "category_main": "買い物", "category_sub": "衣料品", "priority": "中" },
              { "id": "travel_sentences_00054", "en": "Do you have this in another color?", "ja": "これの別の色はありますか？", "year": null, "category_main": "買い物", "category_sub": "衣料品", "priority": "中" },
              { "id": "travel_sentences_00055", "en": "Could you give me a discount?", "ja": "値引きしてもらえますか？", "year": null, "category_main": "買い物", "category_sub": "価格", "priority": "中" },
              { "id": "travel_sentences_00056", "en": "I’m just looking, thank you.", "ja": "見ているだけです、ありがとう。", "year": null, "category_main": "買い物", "category_sub": "店員", "priority": "高" },
              { "id": "travel_sentences_00057", "en": "Could I pay by credit card?", "ja": "クレジットカードで支払えますか？", "year": null, "category_main": "買い物", "category_sub": "支払い", "priority": "高" },
              { "id": "travel_sentences_00058", "en": "Can I get a receipt, please?", "ja": "レシートをもらえますか？", "year": null, "category_main": "買い物", "category_sub": "支払い", "priority": "中" },
              { "id": "travel_sentences_00059", "en": "Is tax included in the price?", "ja": "この値段に税金は含まれていますか？", "year": null, "category_main": "買い物", "category_sub": "支払い", "priority": "中" },
              { "id": "travel_sentences_00060", "en": "Could you wrap this as a gift, please?", "ja": "ギフト用に包んでもらえますか？", "year": null, "category_main": "買い物", "category_sub": "サービス", "priority": "低" },
              { "id": "travel_sentences_00061", "en": "Call the police, please!", "ja": "警察を呼んでください！", "year": null, "category_main": "緊急", "category_sub": "トラブル", "priority": "高" },
              { "id": "travel_sentences_00062", "en": "I need an ambulance!", "ja": "救急車を呼んでください！", "year": null, "category_main": "緊急", "category_sub": "病気", "priority": "高" },
              { "id": "travel_sentences_00063", "en": "My wallet has been stolen.", "ja": "財布を盗まれました。", "year": null, "category_main": "緊急", "category_sub": "トラブル", "priority": "高" },
              { "id": "travel_sentences_00064", "en": "I’ve lost my passport.", "ja": "パスポートをなくしました。", "year": null, "category_main": "緊急", "category_sub": "トラブル", "priority": "高" },
              { "id": "travel_sentences_00065", "en": "I don’t feel well.", "ja": "気分が悪いです。", "year": null, "category_main": "緊急", "category_sub": "病気", "priority": "高" },
              { "id": "travel_sentences_00066", "en": "Where is the nearest hospital?", "ja": "一番近い病院はどこですか？", "year": null, "category_main": "緊急", "category_sub": "病気", "priority": "高" },
              { "id": "travel_sentences_00067", "en": "I need to see a doctor.", "ja": "医者に診てもらいたいです。", "year": null, "category_main": "緊急", "category_sub": "病気", "priority": "中" },
              { "id": "travel_sentences_00068", "en": "Can you help me contact the embassy?", "ja": "大使館に連絡するのを手伝ってもらえますか？", "year": null, "category_main": "緊急", "category_sub": "トラブル", "priority": "中" },
              { "id": "travel_sentences_00069", "en": "Someone is following me.", "ja": "誰かに後をつけられています。", "year": null, "category_main": "緊急", "category_sub": "トラブル", "priority": "中" },
              { "id": "travel_sentences_00070", "en": "I need to report a theft.", "ja": "盗難を届け出たいです。", "year": null, "category_main": "緊急", "category_sub": "トラブル", "priority": "中" },
              { "id": "travel_sentences_00071", "en": "Excuse me.", "ja": "すみません。／ちょっといいですか。", "year": null, "category_main": "汎用", "category_sub": "会話", "priority": "高" },
              { "id": "travel_sentences_00072", "en": "Could you help me, please?", "ja": "手伝ってもらえますか？", "year": null, "category_main": "汎用", "category_sub": "依頼", "priority": "高" },
              { "id": "travel_sentences_00073", "en": "I don’t understand.", "ja": "わかりません。", "year": null, "category_main": "汎用", "category_sub": "会話", "priority": "高" },
              { "id": "travel_sentences_00074", "en": "Could you say that again, please?", "ja": "もう一度言ってもらえますか？", "year": null, "category_main": "汎用", "category_sub": "会話", "priority": "高" },
              { "id": "travel_sentences_00075", "en": "Do you speak English?", "ja": "英語を話せますか？", "year": null, "category_main": "汎用", "category_sub": "会話", "priority": "高" },
              { "id": "travel_sentences_00076", "en": "Could you write it down, please?", "ja": "書いてもらえますか？", "year": null, "category_main": "汎用", "category_sub": "依頼", "priority": "中" },
              { "id": "travel_sentences_00077", "en": "That’s okay, thank you.", "ja": "大丈夫です、ありがとうございます。", "year": null, "category_main": "汎用", "category_sub": "会話", "priority": "中" },
              { "id": "travel_sentences_00078", "en": "Where can I find this?", "ja": "これはどこにありますか？", "year": null, "category_main": "汎用", "category_sub": "道案内", "priority": "中" },
              { "id": "travel_sentences_00079", "en": "I’m sorry, I’m not from around here.", "ja": "すみません、私はこの辺の者ではありません。", "year": null, "category_main": "汎用", "category_sub": "会話", "priority": "低" },
              { "id": "travel_sentences_00080", "en": "Thank you so much!", "ja": "本当にありがとうございます！", "year": null, "category_main": "汎用", "category_sub": "会話", "priority": "高" }
            ];

            ALL_DB = provided_json_content; 

            if (ALL_DB.length === 0) {
                englishTextEl.textContent = `${config.name} のデータがありません。`;
                showMessage('JSONファイルにデータがありません。', 'danger');
                return;
            }
            
            // 場面フィルターを初期化
            setupSceneFilter(ALL_DB); 
            
            // フィルタリングを適用し、最初の文をロード
            filterScenes('ALL'); // デフォルトは全ての場面
            
        } catch (error) {
            console.error("データの読み込み中にエラーが発生しました:", error);
            englishTextEl.textContent = `データの読み込みに失敗しました。\n${error.message}`;
            showMessage('データの読み込みに失敗しました。ローカルサーバーで実行しているか確認してください。', 'danger');
        }
    }
    
    /**
     * 使用場面フィルターの初期設定 (category_mainを使用)
     */
    function setupSceneFilter(data) {
        // 'category_main'フィールドを「使用場面」として利用
        const scenes = new Set(data.map(item => item.category_main).filter(c => c && c.trim() !== ''));
        // 日本語でソート
        const sortedScenes = Array.from(scenes).sort((a, b) => a.localeCompare(b, 'ja', { sensitivity: 'base' })); 
        
        sceneFilterEl.innerHTML = '';
        
        // 全ての場面 (デフォルト)
        const allOption = document.createElement('option');
        allOption.value = 'ALL';
        allOption.textContent = '全ての使用場面';
        sceneFilterEl.appendChild(allOption);
        
        // 各場面のオプションを追加
        sortedScenes.forEach(scene => {
            const option = document.createElement('option');
            option.value = scene;
            option.textContent = scene;
            sceneFilterEl.appendChild(option);
        });
        
        sceneFilterEl.classList.remove('hidden');
    }
    
    /**
     * 使用場面フィルターによるDBの絞り込み (category_mainを使用)
     */
    function filterScenes(scene) {
        if (scene === 'ALL') {
            DB = [...ALL_DB];
        } else {
            // 'category_main'フィールドでフィルタリング
            DB = ALL_DB.filter(item => item.category_main === scene);
        }
        
        if (DB.length === 0) {
            englishTextEl.textContent = '選択された場面に該当するデータがありません。';
            showMessage('データが見つかりませんでした。', 'danger');
            // 進捗表示をリセット
            progressIndicatorEl.textContent = '0/0'; 
            return;
        }

        currentSentenceIndex = 0;
        // 現在のモード設定を維持したまま、最初の文をロード
        changeMode(modeSelectorEl.value); 
    }


    /**
     * 単語並べ替えのために英文を整形し、単語配列を生成する
     */
    function tokenizeSentence(sentence) {
        const words = sentence.trim().replace(/\n/g, ' ').split(/\s+/).filter(w => w.length > 0);
        return words;
    }

    /**
     * モードを切り替える
     */
    function changeMode(mode) {
        if (DB.length === 0) return;

        currentMode = parseInt(mode, 10);
        
        // 全てのモード設定をリセット
        englishTextEl.classList.remove('blur-strong', 'italic', 'text-gray-400');
        translationCardEl.classList.add('hidden');
        toggleTranslationBtn.classList.add('hidden');
        scrambleUiEl.classList.add('hidden');
        checkAnswerBtn.classList.add('hidden');
        resetScrambleBtn.classList.add('hidden');
        messageBoxEl.classList.add('hidden');


        // モード固有のUI設定
        if (currentMode === 1) { // 英文先行
            toggleTranslationBtn.textContent = '和訳を表示';
            toggleTranslationBtn.classList.remove('hidden');
        } else if (currentMode === 2) { // 音声先行
            englishTextEl.classList.add('blur-strong'); // ③ 強いぼかしを適用
            toggleTranslationBtn.textContent = '英文・和訳を表示';
            toggleTranslationBtn.classList.remove('hidden');
        } else if (currentMode === 3) { // 並べ替え
            scrambleUiEl.classList.remove('hidden');
            checkAnswerBtn.classList.remove('hidden');
            resetScrambleBtn.classList.remove('hidden');
        }

        loadSentence(currentSentenceIndex);
    }

    /**
     * 現在の文のデータをUIに読み込む
     */
    function loadSentence(index) {
        if (DB.length === 0) {
             progressIndicatorEl.textContent = '0/0';
             return; 
        }
        
        currentSentenceIndex = (index + DB.length) % DB.length;
        const data = DB[currentSentenceIndex];

        // 進捗状況を更新 (例: 21/100)
        progressIndicatorEl.textContent = `${currentSentenceIndex + 1}/${DB.length}`;

        englishTextEl.innerHTML = data.en.replace(/\n/g, '<br>');
        japaneseTextEl.innerHTML = data.ja.replace(/\n/g, '<br>');

        // 和訳の表示状態を維持したまま更新
        updateTranslationVisibility();

        if (currentMode === 3) {
            setupScrambleMode();
        } else {
            // モード1/2で和訳非表示の場合のぼかし状態を再設定
            if (currentMode === 1 && !isTranslationVisible) {
                englishTextEl.classList.remove('blur-strong');
            } else if (currentMode === 2 && !isTranslationVisible) {
                englishTextEl.classList.add('blur-strong');
            } else {
                 englishTextEl.classList.remove('blur-strong'); // 和訳表示時は英文のぼかしを解除
            }
        }
        
        hideMessage();
    }

    /**
     * 和訳の表示/非表示を切り替える (モード 1, 2)
     */
    function toggleTranslation() {
        isTranslationVisible = !isTranslationVisible;
        updateTranslationVisibility();
    }
    
    /**
     * 和訳の表示状態を更新し、トグルボタンのテキストを変更する
     */
    function updateTranslationVisibility() {
        if (isTranslationVisible) {
            translationCardEl.classList.remove('hidden');
            if (currentMode === 2) {
                 toggleTranslationBtn.textContent = '英文・和訳を非表示';
            } else {
                toggleTranslationBtn.textContent = '和訳を非表示';
            }
            // 英文をはっきり表示
            englishTextEl.classList.remove('blur-strong'); 
        } else {
            translationCardEl.classList.add('hidden');
            if (currentMode === 2) {
                 toggleTranslationBtn.textContent = '英文・和訳を表示';
                 englishTextEl.classList.add('blur-strong'); // ③ 音声先行で非表示なら強くぼかす
            } else {
                toggleTranslationBtn.textContent = '和訳を表示';
                 englishTextEl.classList.remove('blur-strong');
            }
        }
    }


    /**
     * 音声ファイルを再生する
     */
    function playAudio() {
        if (DB.length === 0 || !currentCategoryKey) return;
        
        const data = DB[currentSentenceIndex];
        const config = CATEGORY_MAP[currentCategoryKey];
        
        if (!config || !config.audioFolder) {
             showMessage("エラー: 音声フォルダ設定がありません。", 'danger');
             return;
        }

        // 音声ファイルパスを動的に生成: ./audio/{audioFolder}/{data.id}.mp3
        const audioPath = `./audio/${config.audioFolder}/${data.id}.mp3`;
        
        const audio = new Audio(audioPath);
        audio.play().catch(e => {
            console.error("音声ファイルの再生に失敗しました。ファイルパスを確認してください: ", audioPath, e);
            showMessage("音声ファイルの読み込みまたは再生に失敗しました。パスを確認してください。", 'danger');
        });

        if (currentMode === 2 && !isTranslationVisible) {
             showMessage("音声が再生されました。英文の構成を考えましょう。", 'secondary');
        } else if (currentMode === 3) {
             showMessage("音声が再生されました。単語を並べ替えてください。", 'secondary');
        }
    }

    /**
     * 次または前の文へ移動する
     * @param {number} direction - 1:次, -1:前
     */
    function navigate(direction) {
        if (DB.length === 0) return;
        let newIndex = currentSentenceIndex + direction;
        // ① 並べ替えモードのバグ修正: 文移動後、現在のモードを再適用し、setupScrambleMode()を強制的に実行させる
        loadSentence(newIndex);
        changeMode(currentMode);
    }
    
    // --- モード 3 (並べ替え) のロジック ---

    /**
     * モード3の初期設定と単語シャッフルを行う
     */
    function setupScrambleMode() {
        const data = DB[currentSentenceIndex];
        
        englishTextEl.textContent = '並べ替えモード：以下の単語を正しい順番に組み替えてください。';
        englishTextEl.classList.add('italic', 'text-gray-400');
        englishTextEl.classList.remove('blur-strong'); 

        correctWords = tokenizeSentence(data.en);
        
        scrambledWords = [...correctWords];
        shuffleArray(scrambledWords);
        
        answerSequence = []; 
        
        renderScrambledWords();
        renderAnswerArea();
        hideMessage();
        
        // 並べ替えモードでは和訳を非表示にする
        translationCardEl.classList.add('hidden');
        
        // 並べ替えUIを再表示（回答チェックで非表示になっている可能性があるため）
        scrambleUiEl.classList.remove('hidden');
    }
    
    /**
     * 配列をシャッフルする（Fisher-Yatesアルゴリズム）
     */
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    /**
     * シャッフルされた単語ボタンをレンダリングする
     */
    function renderScrambledWords() {
        scrambledWordsAreaEl.innerHTML = '';
        scrambledWords.forEach((word, index) => {
            const button = document.createElement('button');
            button.className = 'word-button bg-primary text-white text-sm md:text-base font-medium px-3 py-1 rounded-full shadow-md hover:bg-indigo-600 transition-colors duration-200';
            button.textContent = word;
            button.dataset.index = index;
            button.onclick = () => selectWord(word, index);
            if (answerSequence.some(item => item.originalIndex === index)) {
                button.classList.add('selected');
            }
            scrambledWordsAreaEl.appendChild(button);
        });
    }

    /**
     * ユーザー解答エリアをレンダリングする
     */
    function renderAnswerArea() {
        answerAreaEl.innerHTML = '';
        answerSequence.forEach((item, index) => {
            const span = document.createElement('span');
            span.className = 'answer-word bg-white text-gray-800 text-sm md:text-base px-3 py-1 rounded-full shadow border border-gray-300 cursor-pointer';
            span.textContent = item.word;
            span.dataset.originalIndex = item.originalIndex; 
            span.onclick = () => deselectWord(index);
            answerAreaEl.appendChild(span);
        });
        
        // 英文表示エリアに現在の解答を表示
        if (answerSequence.length === 0) {
            englishTextEl.textContent = '並べ替えモード：単語を選択してください';
        } else {
            englishTextEl.textContent = answerSequence.map(item => item.word).join(' ');
        }
    }

    /**
     * シャッフル単語を選択して解答エリアに追加する
     */
    function selectWord(word, originalIndex) {
        const button = scrambledWordsAreaEl.querySelector(`[data-index="${originalIndex}"]`);
        if (button) {
            button.classList.add('selected');
        }

        answerSequence.push({ word, originalIndex });
        renderAnswerArea();
        hideMessage();
    }
    
    /**
     * 解答エリアの単語を削除し、シャッフルエリアに戻す
     */
    function deselectWord(answerIndex) {
        const [removedItem] = answerSequence.splice(answerIndex, 1);
        
        const button = scrambledWordsAreaEl.querySelector(`[data-index="${removedItem.originalIndex}"]`);
        if (button) {
            button.classList.remove('selected');
        }
        
        renderAnswerArea();
        hideMessage();
    }
    
    /**
     * 並べ替えをリセットする
     */
    function resetScramble() {
        setupScrambleMode(); 
        showMessage("並べ替えがリセットされました。", 'gray');
    }

    /**
     * ④ 並べ替えモードの回答チェックと画面調整
     */
    function checkScrambledAnswer() {
        if (answerSequence.length === 0) {
            showMessage("単語を選択して英文を構築してください。", 'danger');
            return;
        }

        const userSentence = answerSequence.map(item => item.word).join(' ');
        const correctSentence = correctWords.join(' ');
        
        const normalizedUser = userSentence.replace(/\s+/g, ' ').trim();
        const normalizedCorrect = correctSentence.replace(/\s+/g, ' ').trim();

        if (normalizedUser === normalizedCorrect) {
            showMessage("正解です！よくできました！", 'secondary');
        } else {
            // 不正解の場合は、正しい英文を確認するように促す
            showMessage("残念！不正解です。正しい英文を確認しましょう。", 'danger');
        }
        
        // **正解・不正解にかかわらず、学習のため正しい英文と和訳を表示し、並べ替えUIを非表示にする** (スクロール回避)
        
        // 1. 正しい英文を表示
        englishTextEl.textContent = correctSentence;
        englishTextEl.classList.remove('italic', 'text-gray-400');
        
        // 2. 並べ替えUIを非表示 (回答に使ったエリアを消す)
        scrambleUiEl.classList.add('hidden');
        
        // 3. 和訳を表示
        translationCardEl.classList.remove('hidden');
    }


    /**
     * メッセージボックスを表示する
     */
    function showMessage(text, type) {
        messageBoxEl.textContent = text;
        messageBoxEl.className = `text-center py-2 px-4 text-lg font-semibold rounded-lg shadow-sm mt-4`;
        
        let bgColor, textColor;
        switch (type) {
            case 'secondary': bgColor = 'bg-green-200'; textColor = 'text-green-800'; break;
            case 'danger': bgColor = 'bg-red-200'; textColor = 'text-red-800'; break;
            case 'primary': bgColor = 'bg-blue-200'; textColor = 'text-blue-800'; break;
            case 'gray': bgColor = 'bg-gray-200'; textColor = 'text-gray-800'; break;
            default: bgColor = 'bg-yellow-200'; textColor = 'text-yellow-800'; break;
        }
        messageBoxEl.classList.add(bgColor, textColor);
        messageBoxEl.classList.remove('hidden');
    }

    /**
     * メッセージボックスを非表示にする
     */
    function hideMessage() {
        messageBoxEl.classList.add('hidden');
    }

</script>
</body>
</html>