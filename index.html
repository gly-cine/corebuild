<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語学習サイト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムフォントとして日本語表示に適したInterを設定 */
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        /* 画面全体にフィットし、スクロールを発生させないためのスタイル */
        .h-screen-no-scroll { height: 100vh; overflow: hidden; }
        .word-button { transition: all 0.2s; }
        .word-button:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .selected { opacity: 0.5; pointer-events: none; }
        /* 音声先行モード用の強いぼかし */
        .blur-strong { filter: blur(8px); }
        
        /* 文法問題の選択肢のホバー効果 */
        .choice-button:not(:disabled):hover { 
            background-color: #f3f4f6; /* gray-100 */
            border-color: #4f46e5; /* primary-600 */
        }

        /* 和訳カードの内容を垂直方向に中央揃えにするためのFlexbox設定 */
        #translation-card { 
            display: flex;
            flex-direction: column; 
            padding: 12px 16px; /* p-3 */
        }
        #translation-card .flex-content-center { 
            display: flex;
            align-items: center; /* 垂直方向の中央揃え */
            justify-content: center; /* 水平方向の中央揃え */
            flex-grow: 1; 
        }
        #translation-card .translation-label {
            align-self: flex-start;
            margin-bottom: 4px; 
        }
        #translation-card #japanese-text {
            min-height: 1.5rem;
        }

        /* 文法問題モードの回答後のレイアウト調整 */
        .grammar-layout-answered {
            display: flex;
            flex-direction: column;
            gap: 12px; /* 12px */
            overflow-y: auto; 
            height: 100%; 
        }

        /* 選択肢を横一列に強制的に並べるためのスタイル調整 */
        .choice-button {
            /* flex-1: 選択肢4つが均等幅になるようにする */
            flex: 1 1 0%; 
            /* min-width: 0 を使うことで、flexアイテムが内容物によって広がりすぎるのを防ぐ */
            min-width: 0;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // スタイリッシュテーマのカラー定義
                        'primary': '#4f46e5', // Indigo-600
                        'secondary': '#10b981', // Emerald-500
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen-no-scroll flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl flex flex-col h-full md:h-5/6 overflow-hidden">

        <header id="app-header" class="p-6 bg-primary text-white rounded-t-xl shadow-lg flex flex-col md:flex-row justify-between items-center hidden">
            <h1 class="text-2xl font-bold tracking-tight mb-3 md:mb-0">海外旅行で便利なフレーズ</h1>
            
            <div class="flex flex-wrap justify-center items-center space-x-4 mt-3 md:mt-0">
                
                <div class="flex items-center space-x-2">
                    <label for="filter-mode-selector" class="text-sm font-medium">表示:</label>
                    <select id="filter-mode-selector" onchange="applyAllFilters()" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        <option value="ALL">全ての英文</option>
                        <option value="UNLEARNED">未学習のみ</option>
                        <option value="LEARNED">学習済のみ</option>
                    </select>
                </div>

                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                    <label for="mode-selector" class="text-sm font-medium">学習モード:</label>
                    <select id="mode-selector" onchange="changeMode(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        <option value="1">① 英文先行</option>
                        <option value="2">② 音声先行</option>
                        <option value="4">③ 文法問題</option>
                    </select>
                </div>
                
                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                    <label for="grammar-type-selector" class="text-sm font-medium">文法類型:</label>
                    <select id="grammar-type-selector" onchange="filterByType(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        </select>
                </div>
            </div>
        </header>

        <main id="main-content" class="flex-grow p-6 flex flex-col space-y-3 overflow-y-auto">

            <div id="selection-screen" class="p-12 flex flex-col items-center justify-center h-full text-center">
                <h2 id="selection-title" class="text-3xl font-extrabold text-gray-800 mb-8">学習コンテンツを選択してください</h2>
                
                <div id="main-category-buttons" class="space-y-6 w-full max-w-md">
                    <button id="btn-travel" onclick="selectCategory('travel')" class="w-full py-4 bg-primary text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-200 transform hover:scale-[1.02]">
                        ✈️ 旅行用英語
                    </button>
                    </div>
            </div>
            
            <div id="learning-screen" class="hidden flex-grow flex flex-col space-y-3">
                
                <div class="text-center text-sm text-gray-500 mb-2 flex justify-between items-center">
                    
                    <span id="progress-indicator" class="px-2 py-1 rounded-md text-gray-600 font-semibold"></span>

                    <div class="flex items-center space-x-2">
                        <label for="scene-filter" class="text-sm font-medium text-gray-600">使用場面:</label>
                        <select id="scene-filter" onchange="filterScenes(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary"></select>
                    </div>

                </div>
    
                <div id="english-display-card" class="bg-indigo-50 p-6 rounded-xl shadow-inner min-h-[100px] flex items-center justify-center transition-all duration-300">
                    <p id="english-text" class="text-xl md:text-2xl font-bold text-gray-800 text-center select-none w-full">
                        </p>
                </div>
    
                
                <div id="grammar-question-ui" class="hidden flex-col space-y-3 pt-2 flex-grow">

                    <div id="grammar-sentence-card" class="bg-indigo-50 p-6 rounded-xl shadow-inner min-h-[80px] flex items-center justify-center transition-all duration-300">
                        <p id="grammar-target-sentence" class="text-xl md:text-2xl font-bold text-gray-800 text-center select-none">
                            </p>
                    </div>
                    
                    <div id="translation-card" class="bg-white border border-gray-200 rounded-xl shadow min-h-[60px] transition-all duration-300 hidden">
                        <p class="translation-label text-sm font-semibold text-gray-600">和訳</p>
                        <div id="translation-content" class="flex-content-center">
                            <p id="japanese-text" class="text-lg text-gray-700 text-center w-full">
                                </p>
                        </div>
                    </div>

                    <p id="grammar-question-text" class="text-xl font-bold text-gray-800 text-center px-4"></p>


                    <div id="grammar-choices" class="flex justify-between gap-2 pt-2 mx-auto w-full"> 
                        <button id="choice-A" onclick="checkGrammarAnswer('A')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button> 
                        <button id="choice-B" onclick="checkGrammarAnswer('B')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                        <button id="choice-C" onclick="checkGrammarAnswer('C')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                        <button id="choice-D" onclick="checkGrammarAnswer('D')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                    </div>

                    <div id="grammar-answer-explanation" class="hidden mt-4 p-3 rounded-xl shadow-xl bg-white border-2 border-green-500 max-w-xl mx-auto w-full flex-shrink-0">
                        <p class="font-bold text-green-700 mb-1 border-b border-green-200 pb-1">【正解】<span id="grammar-correct-answer" class="font-extrabold"></span></p>
                        <p class="font-bold text-gray-700 mt-2 mb-1">【解説】</p>
                        <p id="grammar-explanation-text" class="text-gray-600 text-sm"></p>
                    </div>
                </div>

                <div id="message-box" class="text-center py-2 text-lg font-semibold hidden rounded-lg"></div>
            </div>

        </main>

        <footer id="app-footer" class="p-6 bg-gray-100 rounded-b-xl border-t border-gray-200 flex justify-between items-center flex-wrap hidden">
            <div class="flex space-x-2">
                <button onclick="navigate(-1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    &lt; 前の文
                </button>
                <button onclick="navigate(1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    次の文 &gt;
                </button>
            </div>
            
            <button onclick="showSelectionScreen()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium mt-4 md:mt-0">
                TOP画面
            </button>

            <div class="flex space-x-3 mt-4 md:mt-0">
                
                <button id="toggle-learned-btn" onclick="toggleLearnedStatus()" class="px-6 py-2 bg-secondary text-white font-bold rounded-lg hover:bg-emerald-600 transition-colors shadow-md flex items-center hidden">
                    ✓ 覚えた
                </button>
                
                <button id="toggle-translation-btn" onclick="toggleTranslation()" class="px-6 py-2 bg-primary text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-md hidden">
                    和訳を表示
                </button>

                <button id="play-audio-btn" onclick="playAudio()" class="px-6 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition-colors shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 108 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    音声再生
                </button>
            </div>
        </footer>

    </div>

<script>
    // --- グローバル変数と定数 ---
    let ALL_DB = []; // 読み込んだ全データ
    let DB = []; // 現在の学習データ (フィルタリング後)
    let currentMode = 1; // 1:英文先行, 2:音声先行, 4:文法問題 (デフォルトは1)
    let currentSentenceIndex = 0;
    let isTranslationVisible = false; 
    let currentCategoryKey = ''; 
    const LEARNED_STATUS_KEY = 'learning_app_learned_status'; 
    
    let messageTimeoutId = null; 
    let currentGrammarType = 'ALL'; 

    // JSONパスと対応する音声フォルダを定義
    const CATEGORY_MAP = {
        'travel': { 
            jsonPath: './data/travel_sentences.json', 
            audioFolder: 'travel', 
            name: '旅行用英語',
        },
    };

    // --- DOM要素の参照 ---
    const filterModeSelectorEl = document.getElementById('filter-mode-selector'); 
    const toggleLearnedBtn = document.getElementById('toggle-learned-btn'); 
    const modeSelectorEl = document.getElementById('mode-selector'); 
    const englishTextEl = document.getElementById('english-text');
    const japaneseTextEl = document.getElementById('japanese-text');
    const translationCardEl = document.getElementById('translation-card'); 
    const toggleTranslationBtn = document.getElementById('toggle-translation-btn');
    const messageBoxEl = document.getElementById('message-box');
    const selectionScreenEl = document.getElementById('selection-screen'); 
    const learningScreenEl = document.getElementById('learning-screen'); 
    const appHeaderEl = document.getElementById('app-header'); 
    const appFooterEl = document.getElementById('app-footer'); 
    const progressIndicatorEl = document.getElementById('progress-indicator'); 
    const sceneFilterEl = document.getElementById('scene-filter'); 
    const englishDisplayCard = document.getElementById('english-display-card'); 

    const grammarTypeSelectorEl = document.getElementById('grammar-type-selector'); 
    const grammarQuestionUiEl = document.getElementById('grammar-question-ui');
    const grammarQuestionTextEl = document.getElementById('grammar-question-text');
    const grammarTargetSentenceEl = document.getElementById('grammar-target-sentence');
    const grammarChoicesEl = document.getElementById('grammar-choices');
    const grammarAnswerExplanationEl = document.getElementById('grammar-answer-explanation');
    const grammarCorrectAnswerEl = document.getElementById('grammar-correct-answer');
    const grammarExplanationTextEl = document.getElementById('grammar-explanation-text');
    const mainContentEl = document.getElementById('main-content'); 

    // --- Persistence (学習済ステータスの保存/読み込み) ---

    function loadLearnedStatus() {
        try {
            const stored = localStorage.getItem(LEARNED_STATUS_KEY);
            return stored ? JSON.parse(stored) : {};
        } catch (e) {
            console.error("Failed to load learned status from localStorage", e);
            return {};
        }
    }

    function saveLearnedStatus(statusMap) {
        try {
            localStorage.setItem(LEARNED_STATUS_KEY, JSON.stringify(statusMap));
        } catch (e) {
            console.error("Failed to save learned status to localStorage", e);
        }
    }

    // --- アプリ初期化 ---
    window.onload = function() {
        const savedMode = localStorage.getItem('lastLearningMode');
        if (savedMode) {
            currentMode = parseInt(savedMode, 10);
            modeSelectorEl.value = currentMode;
        }
        showSelectionScreen(); 
    };
    
    function showSelectionScreen() {
        selectionScreenEl.classList.remove('hidden');
        learningScreenEl.classList.add('hidden');
        appHeaderEl.classList.add('hidden');
        appFooterEl.classList.add('hidden');
        
        progressIndicatorEl.textContent = ''; 
        toggleLearnedBtn.classList.add('hidden');
        grammarQuestionUiEl.classList.add('hidden');
        
        mainContentEl.classList.remove('grammar-layout-answered');
        mainContentEl.classList.add('overflow-y-auto');
        
        // 和訳カードを初期位置に戻すために非表示にする
        translationCardEl.classList.add('hidden');
    }

    function selectCategory(category) {
        if (category === 'travel') {
            startLearning('travel');
            return;
        } 
    }
    
    /**
     * 選択されたカテゴリのJSONファイルを非同期で読み込み、学習を開始する
     */
    async function startLearning(key) {
        const config = CATEGORY_MAP[key];
        if (!config) {
            showMessage('エラー: 不正なカテゴリが選択されました！', 'danger');
            return;
        }
        
        // UIの切り替え
        selectionScreenEl.classList.add('hidden');
        learningScreenEl.classList.remove('hidden');
        appHeaderEl.classList.remove('hidden');
        appFooterEl.classList.remove('hidden');
        document.getElementById('app-header').querySelector('h1').textContent = config.name;

        currentCategoryKey = key;
        
        // データを読み込み中であることをすぐに表示
        englishTextEl.textContent = 'データを読み込み中です...'; 
        englishDisplayCard.classList.remove('hidden'); 

        try {
            // 1. JSONファイルの読み込み
            const response = await fetch(config.jsonPath);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status} for ${config.jsonPath}`);
            }
            
            const rawData = await response.json(); // 2. JSONパース
            
            // 3. データ処理とフィルタリング
            const learnedStatusMap = loadLearnedStatus();
            ALL_DB = rawData.map(item => ({
                ...item,
                isLearned: !!learnedStatusMap[item.id]
            })); 

            if (ALL_DB.length === 0) {
                englishTextEl.textContent = `${config.name} のデータがありません。`;
                showMessage('データがありません。', 'danger');
                grammarQuestionUiEl.classList.add('hidden');
                return;
            }
            
            // 場面フィルターを初期化
            setupSceneFilter(ALL_DB); 
            // 文法類型フィルターを初期化
            setupGrammarTypeFilter(ALL_DB);
            
            // モードを適用
            applyAllFilters(); 
            
            if (currentMode === 4) {
                mainContentEl.classList.remove('grammar-layout-answered');
                mainContentEl.classList.add('overflow-y-auto'); 
            }

        } catch (error) {
            console.error("データの読み込みまたは初期化に失敗しました:", error);
            englishTextEl.textContent = `エラーが発生しました: ${config.jsonPath} の読み込みまたはデータ初期化に失敗しました。詳細をブラウザのコンソールで確認してください。`;
            showMessage('データファイルの読み込みまたは初期化エラー。', 'danger');
            return;
        }
    }
    
    function setupSceneFilter(data) {
        // category_mainの件数をカウント
        const categoryCounts = {};
        data.forEach(item => {
            const scene = item.category_main || 'その他';
            categoryCounts[scene] = (categoryCounts[scene] || 0) + 1;
        });

        const scenes = new Set(data.map(item => item.category_main).filter(c => c && c.trim() !== ''));
        const sortedScenes = Array.from(scenes).sort((a, b) => a.localeCompare(b, 'ja', { sensitivity: 'base' })); 
        
        sceneFilterEl.innerHTML = '';
        
        const allOption = document.createElement('option');
        allOption.value = 'ALL';
        allOption.textContent = `全ての使用場面 (${data.length}件)`; 
        sceneFilterEl.appendChild(allOption);
        
        sortedScenes.forEach(scene => {
            const option = document.createElement('option');
            option.value = scene;
            option.textContent = `${scene} (${categoryCounts[scene]}件)`;
            sceneFilterEl.appendChild(option);
        });
        
        sceneFilterEl.classList.remove('hidden');
    }

    function setupGrammarTypeFilter(data) {
        // 文法問題データのみに絞り込む
        const grammarData = data.filter(item => item.grammar_question);

        // grammar_typeの件数をカウント
        const typeCounts = {};
        grammarData.forEach(item => {
            const type = item.grammar_type || '未分類';
            typeCounts[type] = (typeCounts[type] || 0) + 1;
        });

        const types = new Set(grammarData.map(item => item.grammar_type).filter(t => t && t.trim() !== ''));
        const sortedTypes = Array.from(types).sort((a, b) => a.localeCompare(b, 'ja', { sensitivity: 'base' })); 
        
        grammarTypeSelectorEl.innerHTML = ''; 

        // 1. 全て (ALL) オプションを追加
        const allOption = document.createElement('option');
        allOption.value = 'ALL';
        allOption.textContent = `全ての類型 (${grammarData.length}件)`;
        grammarTypeSelectorEl.appendChild(allOption);

        // 2. 各類型オプションを追加
        sortedTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = `${type} (${typeCounts[type]}件)`;
            grammarTypeSelectorEl.appendChild(option);
        });
        
        grammarTypeSelectorEl.value = currentGrammarType; 
    }
    
    function filterByType(type) {
        currentGrammarType = type;
        applyAllFilters();
    }
    
    function filterScenes(scene) {
        applyAllFilters();
    }


    function applyAllFilters() {
        if (ALL_DB.length === 0) return;
        
        // 1. 場面フィルターの適用
        const scene = sceneFilterEl.value;
        let tempDB = (scene === 'ALL') 
            ? ALL_DB 
            : ALL_DB.filter(item => item.category_main === scene);
            
        // 2. 学習済フィルターの適用
        const learnedFilter = filterModeSelectorEl.value;
        if (learnedFilter === 'LEARNED') {
            tempDB = tempDB.filter(item => item.isLearned);
        } else if (learnedFilter === 'UNLEARNED') {
            tempDB = tempDB.filter(item => !item.isLearned);
        }
        
        // 3. モード固有のフィルターを適用
        if (currentMode === 4) { // 文法問題モード
            let grammarDB = tempDB.filter(item => item.grammar_question);
            // 文法類型フィルターの適用を追加
            if (currentGrammarType !== 'ALL') {
                grammarDB = grammarDB.filter(item => item.grammar_type === currentGrammarType);
            }
            DB = grammarDB;
        } else { // 英文先行/音声先行モード
            DB = tempDB;
        }

        // モードに応じて表示エリアを切り替え
        const isGrammarMode = currentMode === 4;
        englishDisplayCard.classList.toggle('hidden', isGrammarMode);
        grammarQuestionUiEl.classList.toggle('hidden', !isGrammarMode);

        if (DB.length === 0) {
             englishTextEl.textContent = '選択された条件に該当するデータがありません。';
             showMessage('データが見つかりませんでした。', 'danger');
             progressIndicatorEl.textContent = '0/0'; 
             toggleLearnedBtn.classList.add('hidden');
             englishTextEl.classList.remove('italic', 'text-gray-400', 'blur-strong');
             translationCardEl.classList.add('hidden');
             return;
        }

        currentSentenceIndex = 0;
        loadSentence(currentSentenceIndex);
    }
    
    /**
     * モードを切り替える
     */
    function changeMode(mode) {
        currentMode = parseInt(mode, 10);
        localStorage.setItem('lastLearningMode', currentMode);
        modeSelectorEl.value = currentMode;
        isTranslationVisible = false; 
        
        translationCardEl.classList.add('hidden');
        englishTextEl.classList.remove('blur-strong', 'italic', 'text-gray-400');
        
        const isGrammarMode = currentMode === 4;
        
        // モード切り替え時に表示エリアをリセット
        englishDisplayCard.classList.toggle('hidden', isGrammarMode);
        grammarQuestionUiEl.classList.toggle('hidden', !isGrammarMode);
        
        toggleLearnedBtn.classList.toggle('hidden', isGrammarMode);
        toggleTranslationBtn.classList.toggle('hidden', isGrammarMode); 
        
        if (currentMode === 1) { // 英文先行
            toggleTranslationBtn.textContent = '和訳を表示';
        } else if (currentMode === 2) { // 音声先行
            toggleTranslationBtn.textContent = '英文・和訳を表示';
        } 
        
        // モード切り替え時にレイアウトをリセット
        mainContentEl.classList.remove('grammar-layout-answered');
        mainContentEl.classList.add('overflow-y-auto');

        applyAllFilters(); 
    }

    /**
     * 現在の文のデータをUIに読み込む
     */
    function loadSentence(index) {
        if (DB.length === 0) {
             progressIndicatorEl.textContent = '0/0';
             return; 
        }
        
        currentSentenceIndex = (index + DB.length) % DB.length;
        const data = DB[currentSentenceIndex];

        // 進捗状況を更新
        progressIndicatorEl.textContent = `${currentSentenceIndex + 1}/${DB.length}`;

        // 英文/和訳表示エリアのクリアとリセット
        englishTextEl.classList.remove('italic', 'text-gray-400', 'blur-strong');
        translationCardEl.classList.add('hidden');
        isTranslationVisible = false;
        
        // 回答エリアを隠し、スクロールを許可する
        grammarAnswerExplanationEl.classList.add('hidden');
        mainContentEl.classList.remove('grammar-layout-answered');
        mainContentEl.classList.add('overflow-y-auto');

        // モードによる表示の分岐
        if (currentMode === 4) {
            
            // ★ 修正 ①: 文法問題モードでは、前回の和訳と解答結果を完全にクリアする
            japaneseTextEl.textContent = ' '; 
            grammarAnswerExplanationEl.classList.add('hidden');
            
            setupGrammarMode(data);
        } else {
            // 通常モードの処理
            
            englishTextEl.textContent = data.en.replace(/\n/g, '<br>');
            // ★ 修正 ①: 和訳テキストを現在のデータに合わせる (通常モード)
            japaneseTextEl.textContent = data.ja.replace(/\n/g, '<br>'); 

            if (currentMode === 2) {
                englishTextEl.classList.add('blur-strong');
            }
            
            updateTranslationVisibility(); 
            updateLearnedButtonUI(data.isLearned);
        }
        
        hideMessage();
    }
    
    // --- モード 4 (文法問題) のロジック ---

    function setupGrammarMode(data) {
        // 共通要素の非表示/表示
        englishDisplayCard.classList.add('hidden');
        // ★ 修正 ②: 解答前は和訳カードを確実に非表示にする
        translationCardEl.classList.add('hidden'); 
        grammarQuestionUiEl.classList.remove('hidden');

        grammarAnswerExplanationEl.classList.add('hidden');
        
        // ★ 修正 ①: 選択肢の色をリセットする
        document.querySelectorAll('.choice-button').forEach(button => {
            button.disabled = false;
            button.classList.remove('bg-red-400', 'text-white', 'bg-green-400', 'bg-green-200', 'text-green-800', 'bg-secondary', 'opacity-50', 'pointer-events-none', 'bg-danger');
            button.classList.add('bg-gray-100', 'border-gray-300');
        });
        
        if (!data.grammar_question) {
            // 問題データがない場合の表示
            grammarQuestionTextEl.textContent = '【文法問題】問題データがありません。次の文へ進んでください。';
            grammarTargetSentenceEl.textContent = '問題データがありません。';
            grammarTargetSentenceEl.classList.add('italic', 'text-gray-400');
            grammarChoicesEl.classList.add('hidden');
            return;
        }

        // 解答前は指示文を表示
        grammarQuestionTextEl.textContent = '正しい選択肢を選んでください。'; 
        
        grammarTargetSentenceEl.textContent = data.grammar_question; // 問題となる英文 (空欄あり)
        grammarTargetSentenceEl.classList.remove('italic', 'text-gray-400');
        grammarChoicesEl.classList.remove('hidden');
        
        // 選択肢テキストの調整 (A. B. などを付与)
        document.getElementById('choice-A').textContent = `${data.grammar_choice_a}`;
        document.getElementById('choice-B').textContent = `${data.grammar_choice_b}`;
        document.getElementById('choice-C').textContent = `${data.grammar_choice_c}`;
        document.getElementById('choice-D').textContent = `${data.grammar_choice_d}`;

    }

    function checkGrammarAnswer(choiceLetter) {
        const currentQuestion = DB[currentSentenceIndex];
        const userAnswer = currentQuestion['grammar_choice_' + choiceLetter.toLowerCase()];
        const correctAnswerText = currentQuestion.grammar_answer;
        
        // grammar_answerは "D. check in" の形式を期待
        const isCorrect = userAnswer === correctAnswerText;

        document.querySelectorAll('.choice-button').forEach(button => {
            button.disabled = true;
            button.classList.add('opacity-50', 'pointer-events-none'); // 選択肢を無効化
        });

        const selectedButton = document.getElementById(`choice-${choiceLetter}`);
        selectedButton.classList.remove('bg-gray-100', 'border-gray-300', 'opacity-50', 'pointer-events-none');

        if (isCorrect) {
            showMessage('正解です！', 'secondary');
            selectedButton.classList.add('bg-secondary', 'text-white');
        } else {
            showMessage('残念！不正解です。', 'danger');
            selectedButton.classList.add('bg-danger', 'text-white');
            
            const correctChoiceLetter = correctAnswerText.substring(0, 1);
            const correctButton = document.getElementById(`choice-${correctChoiceLetter}`);
            correctButton.classList.remove('bg-gray-100', 'border-gray-300', 'opacity-50', 'pointer-events-none');
            correctButton.classList.add('bg-green-200', 'text-green-800'); 
        }
        
        // 解答後は指示文を非表示
        grammarQuestionTextEl.textContent = ''; 

        // 正しい英文と和訳の表示
        grammarTargetSentenceEl.textContent = currentQuestion.en; // 問題英文カードに正解の英文を表示
        grammarTargetSentenceEl.classList.remove('italic', 'text-gray-400');
        
        // 和訳カードを正しく表示する (内容を現在のデータに合わせる)
        japaneseTextEl.textContent = currentQuestion.ja.replace(/\n/g, '<br>');
        translationCardEl.classList.remove('hidden'); 

        // 解答エリア表示のため、メインコンテンツのレイアウトを変更し、スクロールを制御
        mainContentEl.classList.add('grammar-layout-answered');
        mainContentEl.classList.remove('overflow-y-auto');
        
        grammarCorrectAnswerEl.textContent = correctAnswerText;
        grammarExplanationTextEl.textContent = currentQuestion.grammar_explanation;
        grammarAnswerExplanationEl.classList.remove('hidden');
    }
    
    // --- 共通ロジック (変更なし) ---
    function toggleTranslation() {
        if (currentMode === 4) return;
        isTranslationVisible = !isTranslationVisible;
        updateTranslationVisibility();
    }
    
    function updateTranslationVisibility() {
        if (currentMode === 4) return;
        
        if (isTranslationVisible) {
            translationCardEl.classList.remove('hidden');
            toggleTranslationBtn.textContent = (currentMode === 2) ? '英文・和訳を非表示' : '和訳を非表示';
            englishTextEl.classList.remove('blur-strong'); 
        } else {
            translationCardEl.classList.add('hidden');
            toggleTranslationBtn.textContent = (currentMode === 2) ? '英文・和訳を表示' : '和訳を表示';
            if (currentMode === 2) {
                 englishTextEl.classList.add('blur-strong'); 
            } else {
                englishTextEl.classList.remove('blur-strong');
            }
        }
        toggleTranslationBtn.classList.remove('hidden'); 
    }

    function toggleLearnedStatus() {
        if (DB.length === 0 || currentMode === 4) return; 

        const currentData = DB[currentSentenceIndex];
        const sentenceId = currentData.id;
        
        currentData.isLearned = !currentData.isLearned; 
        
        const learnedStatusMap = loadLearnedStatus();
        if (currentData.isLearned) {
            learnedStatusMap[sentenceId] = true;
            showMessage("「学習済」にチェックしました！", 'secondary');
        } else {
            delete learnedStatusMap[sentenceId]; 
            showMessage("「未学習」に戻しました。", 'gray');
        }
        saveLearnedStatus(learnedStatusMap);

        updateLearnedButtonUI(currentData.isLearned);
        
        const learnedFilter = filterModeSelectorEl.value;
        if ((learnedFilter === 'LEARNED' && !currentData.isLearned) || 
            (learnedFilter === 'UNLEARNED' && currentData.isLearned)) {
            
            applyAllFilters();
        }
    }
    
    function updateLearnedButtonUI(isLearned) {
        if (DB.length === 0 || currentMode === 4) {
             toggleLearnedBtn.classList.add('hidden');
             return;
        }
        
        if (isLearned) {
            toggleLearnedBtn.textContent = '✅ 解除'; 
            toggleLearnedBtn.classList.remove('bg-secondary', 'hover:bg-emerald-600');
            toggleLearnedBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        } else {
            toggleLearnedBtn.textContent = '✓ 覚えた'; 
            toggleLearnedBtn.classList.add('bg-secondary', 'hover:bg-emerald-600');
            toggleLearnedBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
        }
        toggleLearnedBtn.classList.remove('hidden');
    }

    function playAudio() {
        if (DB.length === 0 || !currentCategoryKey) return;
        
        const data = DB[currentSentenceIndex];
        const config = CATEGORY_MAP[currentCategoryKey];
        
        if (!config || !config.audioFolder) {
             showMessage("エラー: 音声フォルダ設定がありません。", 'danger');
             return;
        }

        const audioPath = `./audio/${config.audioFolder}/${data.id}.mp3`;
        
        const audio = new Audio(audioPath);
        audio.play().catch(e => {
            console.error("音声ファイルの再生に失敗しました。ファイルパスを確認してください: ", audioPath, e);
            showMessage("音声ファイルの読み込みまたは再生に失敗しました。パスを確認してください。", 'danger');
        });

        if (currentMode === 2 && !isTranslationVisible) {
             showMessage("音声が再生されました。英文の構成を考えましょう。", 'secondary');
        } else if (currentMode === 4) {
             showMessage("問題文の音声が再生されました。", 'primary');
        }
    }

    function navigate(direction) {
        if (DB.length === 0) return;
        let newIndex = currentSentenceIndex + direction;
        if (newIndex < 0) newIndex = DB.length - 1;
        
        isTranslationVisible = false; 
        loadSentence(newIndex);
    }
    
    /**
     * メッセージボックスを表示し、3秒後に非表示にする
     */
    function showMessage(text, type) {
        if (messageTimeoutId) {
            clearTimeout(messageTimeoutId);
        }
        
        messageBoxEl.textContent = text;
        messageBoxEl.className = `text-center py-2 px-4 text-lg font-semibold rounded-lg shadow-sm mt-4`;
        
        let bgColor, textColor;
        switch (type) {
            case 'secondary': bgColor = 'bg-emerald-200'; textColor = 'text-emerald-800'; break; // Secondaryカラー (Emerald)
            case 'danger': bgColor = 'bg-red-200'; textColor = 'text-red-800'; break;
            case 'primary': bgColor = 'bg-indigo-200'; textColor = 'text-indigo-800'; break; // Primaryカラー (Indigo)
            case 'gray': bgColor = 'bg-gray-200'; textColor = 'text-gray-800'; break;
            default: bgColor = 'bg-yellow-200'; textColor = 'text-yellow-800'; break;
        }
        messageBoxEl.classList.add(bgColor, textColor);
        messageBoxEl.classList.remove('hidden');
        
        // 3秒後に非表示にするタイマーを設定
        messageTimeoutId = setTimeout(hideMessage, 3000); 
    }

    function hideMessage() {
        messageBoxEl.classList.add('hidden');
        messageTimeoutId = null;
    }

</script>
</body>
</html>