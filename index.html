<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±èªå­¦ç¿’ã‚µã‚¤ãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚©ãƒ³ãƒˆã¨ã—ã¦æ—¥æœ¬èªè¡¨ç¤ºã«é©ã—ãŸInterã‚’è¨­å®š */
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        /* ç”»é¢å…¨ä½“ã«ãƒ•ã‚£ãƒƒãƒˆã—ã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç™ºç”Ÿã•ã›ãªã„ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .h-screen-no-scroll { height: 100vh; overflow: hidden; }
        .word-button { transition: all 0.2s; }
        .word-button:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .selected { opacity: 0.5; pointer-events: none; }
        /* éŸ³å£°å…ˆè¡Œãƒ¢ãƒ¼ãƒ‰ç”¨ã®å¼·ã„ã¼ã‹ã— */
        .blur-strong { filter: blur(8px); }
        
        /* æ–‡æ³•å•é¡Œã®é¸æŠè‚¢ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
        .choice-button:not(:disabled):hover { 
            background-color: #f3f4f6; /* gray-100 */
            border-color: #4f46e5; /* primary-600 */
        }

        /* è‹±æ–‡å…ˆè¡Œãƒ»éŸ³å£°å…ˆè¡Œãƒ¢ãƒ¼ãƒ‰ã®å’Œè¨³ã‚«ãƒ¼ãƒ‰ */
        #translation-card { 
            display: flex;
            flex-direction: column; 
            padding: 16px; /* p-4 */
            min-height: 100px; /* æœ€å°ã®é«˜ã•ã‚’ç¢ºä¿ */
            position: relative; /* ãƒ©ãƒ™ãƒ«ã®çµ¶å¯¾é…ç½®ç”¨ */
        }
        #translation-card .flex-content-center { 
            display: flex;
            align-items: center; 
            justify-content: center; 
            flex-grow: 1;
            width: 100%;
            height: 100%; /* è¦ªè¦ç´ å…¨ä½“ã‚’ä½¿ç”¨ */
        }
        #translation-card .translation-label {
            position: absolute; /* çµ¶å¯¾é…ç½®ã§ã‚¹ãƒšãƒ¼ã‚¹ã‚’å æœ‰ã—ãªã„ã‚ˆã†ã« */
            top: 16px;
            left: 16px;
            margin-bottom: 0;
        }
        #translation-card #japanese-text {
            min-height: 1.5rem;
        }

        /* æ–‡æ³•å•é¡Œãƒ¢ãƒ¼ãƒ‰ã®å’Œè¨³ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        #grammar-translation-card { 
            display: flex;
            flex-direction: column; 
            padding: 16px; /* p-4 */
            position: relative; /* ãƒ©ãƒ™ãƒ«ã®çµ¶å¯¾é…ç½®ç”¨ */
            min-height: 100px; /* æœ€å°é«˜ã•ã‚’ç¢ºä¿ */
        }
        #grammar-translation-card .flex-content-center {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
            width: 100%;
            height: 100%; /* è¦ªè¦ç´ å…¨ä½“ã‚’ä½¿ç”¨ */
        }
        #grammar-translation-card .translation-label {
            position: absolute; /* çµ¶å¯¾é…ç½®ã§ã‚¹ãƒšãƒ¼ã‚¹ã‚’å æœ‰ã—ãªã„ã‚ˆã†ã« */
            top: 16px;
            left: 16px;
            margin-bottom: 0;
            padding-left: 0;
        }
        #grammar-translation-card #grammar-japanese-text {
            min-height: 1.5rem;
        }
        
        /* è‹±æ–‡è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ã¨æ–‡æ³•å•é¡Œã‚«ãƒ¼ãƒ‰ã®é«˜ã•ã‚’çµ±ä¸€ */
        #english-display-card,
        #grammar-sentence-card {
            min-height: 100px;
            padding-bottom: 32px; /* å‡ºå…¸è¡¨ç¤ºç”¨ã®ä½™ç™½ */
        }

        /* æ–‡æ³•å•é¡Œãƒ¢ãƒ¼ãƒ‰ã®å›ç­”å¾Œã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
        .grammar-layout-answered {
            display: flex;
            flex-direction: column;
            gap: 12px; /* 12px */
            overflow-y: auto; 
            height: 100%; 
        }

        /* é¸æŠè‚¢ã‚’æ¨ªä¸€åˆ—ã«å¼·åˆ¶çš„ã«ä¸¦ã¹ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .choice-button {
            flex: 1 1 0%; 
            min-width: 0;
        }
        
        /* å‡ºå…¸è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .source-citation {
            position: absolute;
            bottom: 5px; /* 16pxã‹ã‚‰5pxã«å¤‰æ›´ï¼ˆä½™ç™½ã‚’è¿‘ãã«ï¼‰ */
            right: 12px;
            font-size: 0.75rem;
            color: #9ca3af;
            font-weight: 500;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ã‚¹ã‚¿ã‚¤ãƒªãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒã®ã‚«ãƒ©ãƒ¼å®šç¾©
                        'primary': '#4f46e5', // Indigo-600
                        'secondary': '#10b981', // Emerald-500
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen-no-scroll flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl flex flex-col h-full md:h-5/6 overflow-hidden">

        <header id="app-header" class="p-6 bg-primary text-white rounded-t-xl shadow-lg flex flex-col md:flex-row justify-between items-center hidden">
            <h1 class="text-2xl font-bold tracking-tight mb-3 md:mb-0">æµ·å¤–æ—…è¡Œã§ä¾¿åˆ©ãªãƒ•ãƒ¬ãƒ¼ã‚º</h1>
            
            <div class="flex flex-wrap justify-center items-center space-x-4 mt-3 md:mt-0">
                
                <div class="flex items-center space-x-2">
                    <label for="filter-mode-selector" class="text-sm font-medium">è¡¨ç¤º:</label>
                    <select id="filter-mode-selector" onchange="applyAllFilters()" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        <option value="ALL">å…¨ã¦ã®è‹±æ–‡</option>
                        <option value="UNLEARNED">æœªå­¦ç¿’ã®ã¿</option>
                        <option value="LEARNED">å­¦ç¿’æ¸ˆã®ã¿</option>
                    </select>
                </div>

                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                    <label for="mode-selector" class="text-sm font-medium">å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰:</label>
                    <select id="mode-selector" onchange="changeMode(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        <option value="1">â‘  è‹±æ–‡å…ˆè¡Œ</option>
                        <option value="2">â‘¡ éŸ³å£°å…ˆè¡Œ</option>
                        <option value="4">â‘¢ æ–‡æ³•å•é¡Œ</option>
                    </select>
                </div>
                
            </div>
        </header>

        <main id="main-content" class="flex-grow p-6 flex flex-col space-y-3 overflow-y-auto">

            <div id="selection-screen" class="p-12 flex flex-col items-center justify-center h-full text-center">
                <h2 id="selection-title" class="text-3xl font-extrabold text-gray-800 mb-8">å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
                
                <div id="main-category-buttons" class="space-y-6 w-full max-w-md">
    <button id="btn-travel" onclick="selectCategory('travel')" class="w-full py-4 bg-primary text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-200 transform hover:scale-[1.02]">
        âœˆï¸ æ—…è¡Œç”¨è‹±èª
    </button>
    <button id="btn-highschool" onclick="showHighSchoolSubcategories()" class="w-full py-4 bg-purple-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-purple-700 transition-colors duration-200 transform hover:scale-[1.02]">
        ğŸ“š é«˜æ ¡å—é¨“ç”¨è‹±èª
    </button>
</div>

<div id="highschool-subcategory-buttons" class="space-y-6 w-full max-w-md hidden">
    <button onclick="selectCategory('highschool_listening')" class="w-full py-4 bg-indigo-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-200 transform hover:scale-[1.02]">
        ğŸ§ ãƒªã‚¹ãƒ‹ãƒ³ã‚°
    </button>
    <button onclick="selectCategory('highschool_reading')" class="w-full py-4 bg-blue-600 text-white text-xl font-bold rounded-xl shadow-lg hover:bg-blue-700 transition-colors duration-200 transform hover:scale-[1.02]">
        ğŸ“– ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
    </button>
    <button onclick="backToMainCategories()" class="w-full py-3 bg-gray-400 text-white text-lg font-semibold rounded-xl shadow hover:bg-gray-500 transition-colors duration-200">
        â† æˆ»ã‚‹
    </button>
</div>

            </div>
            
            <div id="learning-screen" class="hidden flex-grow flex flex-col space-y-3">
                
                <div class="text-center text-sm text-gray-500 mb-2 flex justify-between items-center">
                    
                    <span id="progress-indicator" class="px-2 py-1 rounded-md text-gray-600 font-semibold"></span>

                    <div id="scene-filter-container" class="flex items-center space-x-2">
                        <label for="scene-filter" class="text-sm font-medium text-gray-600">ä½¿ç”¨å ´é¢:</label>
                        <select id="scene-filter" onchange="filterScenes(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary"></select>
                    </div>

                    <div id="grammar-type-filter-container" class="flex items-center space-x-2 hidden">
                        <label for="grammar-type-selector" class="text-sm font-medium text-gray-600">æ–‡æ³•é¡å‹:</label>
                        <select id="grammar-type-selector" onchange="filterByType(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        </select>
                    </div>

                </div>
    
                <div id="english-display-card" class="bg-indigo-50 p-6 rounded-xl shadow-inner min-h-[100px] flex items-center justify-center transition-all duration-300 relative">
                    <p id="english-text" class="text-xl md:text-2xl font-bold text-gray-800 text-center select-none w-full">
                        </p>
                    <p id="source-citation" class="source-citation hidden"></p>
                </div>
    
                <div id="translation-card" class="bg-white border border-gray-200 rounded-xl shadow min-h-[60px] transition-all duration-300 hidden">
                    <p class="translation-label text-sm font-semibold text-gray-600">å’Œè¨³</p>
                    <div id="translation-content" class="flex-content-center">
                        <p id="japanese-text" class="text-lg text-gray-700 text-center w-full">
                            </p>
                    </div>
                </div>

                <div id="grammar-question-ui" class="hidden flex-col space-y-3 pt-2 flex-grow">

                    <div id="grammar-sentence-card" class="bg-indigo-50 p-6 rounded-xl shadow-inner min-h-[80px] flex items-center justify-center transition-all duration-300 relative">
                        <p id="grammar-target-sentence" class="text-xl md:text-2xl font-bold text-gray-800 text-center select-none">
                            </p>
                        <p id="grammar-source-citation" class="source-citation hidden"></p>
                    </div>
                    
                    <div id="grammar-translation-card" class="bg-white border border-gray-200 rounded-xl shadow min-h-[60px] transition-all duration-300 hidden">
                        <p class="translation-label text-sm font-semibold text-gray-600">å’Œè¨³</p>
                        <div id="grammar-translation-content" class="flex-content-center">
                            <p id="grammar-japanese-text" class="text-lg text-gray-700 text-center w-full">
                                </p>
                        </div>
                    </div>

                    <p id="grammar-question-text" class="text-xl font-bold text-gray-800 text-center px-4"></p>


                    <div id="grammar-choices" class="flex justify-between gap-2 pt-2 mx-auto w-full"> 
                        <button id="choice-A" onclick="checkGrammarAnswer('A')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button> 
                        <button id="choice-B" onclick="checkGrammarAnswer('B')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                        <button id="choice-C" onclick="checkGrammarAnswer('C')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                        <button id="choice-D" onclick="checkGrammarAnswer('D')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                    </div>

                    <div id="grammar-answer-explanation" class="hidden mt-4 p-3 rounded-xl shadow-xl bg-white border-2 border-green-500 max-w-xl mx-auto w-full flex-shrink-0">
                        <p class="font-bold text-green-700 mb-1 border-b border-green-200 pb-1">ã€æ­£è§£ã€‘<span id="grammar-correct-answer" class="font-extrabold"></span></p>
                        <p class="font-bold text-gray-700 mt-2 mb-1">ã€è§£èª¬ã€‘</p>
                        <p id="grammar-explanation-text" class="text-gray-600 text-sm"></p>
                    </div>
                </div>

                <div id="message-box" class="text-center py-2 text-lg font-semibold hidden rounded-lg"></div>
            </div>

        </main>

        <footer id="app-footer" class="p-6 bg-gray-100 rounded-b-xl border-t border-gray-200 flex justify-between items-center flex-wrap hidden">
            <div class="flex space-x-2">
                <button onclick="navigate(-1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    &lt; å‰ã®æ–‡
                </button>
                <button onclick="navigate(1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    æ¬¡ã®æ–‡ &gt;
                </button>
            </div>
            
            <button onclick="showSelectionScreen()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium mt-4 md:mt-0">
                TOPç”»é¢
            </button>

            <div class="flex space-x-3 mt-4 md:mt-0">
                
                <button id="toggle-learned-btn" onclick="toggleLearnedStatus()" class="px-6 py-2 bg-secondary text-white font-bold rounded-lg hover:bg-emerald-600 transition-colors shadow-md flex items-center">
                    âœ“ è¦šãˆãŸ
                </button>
                
                <button id="toggle-translation-btn" onclick="toggleTranslation()" class="px-6 py-2 bg-primary text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                    å’Œè¨³ã‚’è¡¨ç¤º
                </button>

                <button id="play-audio-btn" onclick="playAudio()" class="px-6 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition-colors shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 108 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    éŸ³å£°å†ç”Ÿ
                </button>
            </div>
        </footer>

    </div>

<script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨å®šæ•° ---
    let ALL_DB = []; 
    let DB = []; 
    let currentMode = 1; 
    let currentSentenceIndex = 0;
    let isTranslationVisible = false; 
    let currentCategoryKey = ''; 
    const LEARNED_STATUS_KEY = 'learning_app_learned_status';
    let messageTimeoutId = null;
    let currentGrammarType = 'ALL';
    let currentSceneFilter = 'ALL';
    let lastDisplayedId = ''; // ç¾åœ¨è¡¨ç¤ºä¸­ã®è‹±æ–‡ã®IDã‚’è¨˜éŒ²

    // JSONãƒ‘ã‚¹ã¨å¯¾å¿œã™ã‚‹éŸ³å£°ãƒ•ã‚©ãƒ«ãƒ€ã‚’å®šç¾©
    const CATEGORY_MAP = {
    'travel': {
        jsonPath: './data/travel_sentences.json',
        audioFolder: 'travel',
        name: 'æ—…è¡Œç”¨è‹±èª',
        hasSceneFilter: true,
    },
    'highschool_listening': {
        jsonPath: './data/high_school_listening_sentences.json',
        audioFolder: 'high_school/listening',
        name: 'é«˜æ ¡å—é¨“ç”¨è‹±èª - ãƒªã‚¹ãƒ‹ãƒ³ã‚°',
        hasSceneFilter: false,
    },
    'highschool_reading': {
        jsonPath: './data/high_school_reading_sentences.json',
        audioFolder: 'high_school/reading',
        name: 'é«˜æ ¡å—é¨“ç”¨è‹±èª - ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°',
        hasSceneFilter: false,
    },
};

    // --- DOMè¦ç´ ã®å‚ç…§ ---
    const appHeaderEl = document.getElementById('app-header');
    const appFooterEl = document.getElementById('app-footer');
    const selectionScreenEl = document.getElementById('selection-screen');
    const learningScreenEl = document.getElementById('learning-screen');
    const mainContentEl = document.getElementById('main-content');
    const filterModeSelectorEl = document.getElementById('filter-mode-selector');
    const toggleLearnedBtn = document.getElementById('toggle-learned-btn');
    const toggleTranslationBtn = document.getElementById('toggle-translation-btn');
    const englishTextEl = document.getElementById('english-text');
    const japaneseTextEl = document.getElementById('japanese-text');
    const translationCardEl = document.getElementById('translation-card'); // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã®å’Œè¨³ã‚«ãƒ¼ãƒ‰
    const progressIndicatorEl = document.getElementById('progress-indicator');
    const sceneFilterEl = document.getElementById('scene-filter');
    const modeSelectorEl = document.getElementById('mode-selector');
    const englishDisplayCard = document.getElementById('english-display-card');
    const grammarQuestionUiEl = document.getElementById('grammar-question-ui');
    const grammarTargetSentenceEl = document.getElementById('grammar-target-sentence');
    const grammarQuestionTextEl = document.getElementById('grammar-question-text');
    const grammarChoicesEl = document.getElementById('grammar-choices');
    const grammarAnswerExplanationEl = document.getElementById('grammar-answer-explanation');
    const grammarCorrectAnswerEl = document.getElementById('grammar-correct-answer');
    const grammarExplanationTextEl = document.getElementById('grammar-explanation-text');
    const messageBoxEl = document.getElementById('message-box');
    const grammarTypeSelectorEl = document.getElementById('grammar-type-selector');
    const grammarTranslationCardEl = document.getElementById('grammar-translation-card'); // æ–‡æ³•å•é¡Œãƒ¢ãƒ¼ãƒ‰ã®å’Œè¨³ã‚«ãƒ¼ãƒ‰
    const grammarJapaneseTextEl = document.getElementById('grammar-japanese-text');
    const sceneFilterContainerEl = document.getElementById('scene-filter-container');
    const grammarTypeFilterContainerEl = document.getElementById('grammar-type-filter-container');
    const playAudioBtn = document.getElementById('play-audio-btn');
    const sourceCitationEl = document.getElementById('source-citation');
    const grammarSourceCitationEl = document.getElementById('grammar-source-citation');

    // --- åˆæœŸåŒ–å‡¦ç† ---

    document.addEventListener('DOMContentLoaded', () => {
        clearMessage(); 

        // ã€ä¿®æ­£â‘ ã€‘ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã®æŒ™å‹•ã‚’åˆ¶å¾¡
        const lastCategory = localStorage.getItem('lastLearningCategory');
        const lastMode = localStorage.getItem('lastLearningMode');
        const isReload = sessionStorage.getItem('isReload');

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã§ã®ãƒªãƒ­ãƒ¼ãƒ‰ã®å ´åˆã€å‰å›ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
        if (isReload === 'true' && lastCategory && CATEGORY_MAP[lastCategory]) {
            selectCategory(lastCategory, false);
            if (lastMode) {
                changeMode(lastMode);
            }
        } else {
            // åˆå›ã‚¢ã‚¯ã‚»ã‚¹ã®å ´åˆã¯TOPç”»é¢ã‚’è¡¨ç¤º
            showSelectionScreen();
        }

        // ãƒªãƒ­ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆæ¬¡å›ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã«çŠ¶æ…‹å¾©å…ƒã§ãã‚‹ã‚ˆã†ã«ï¼‰
        sessionStorage.setItem('isReload', 'true');
    });
    /**
     * ã‚«ãƒ†ã‚´ãƒªé¸æŠç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
     */
    function showSelectionScreen() {
        appHeaderEl.classList.add('hidden');
        appFooterEl.classList.add('hidden');
        learningScreenEl.classList.add('hidden');
        selectionScreenEl.classList.remove('hidden');
        mainContentEl.classList.remove('grammar-layout-answered');
        mainContentEl.classList.add('overflow-y-auto'); 
        
        // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã€ãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒªç”»é¢ã‚’è¡¨ç¤º
        document.getElementById('highschool-subcategory-buttons').classList.add('hidden');
        document.getElementById('main-category-buttons').classList.remove('hidden');
        document.getElementById('selection-title').textContent = 'å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é¸æŠã—ã¦ãã ã•ã„';
        
        currentCategoryKey = '';
        currentSceneFilter = 'ALL'; 
        currentGrammarType = 'ALL'; 
        translationCardEl.classList.add('hidden'); 
        
        sessionStorage.removeItem('isReload');
        
        clearMessage();
    }



    /**
     * ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ã¦ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®é¸æŠè‚¢ã‚’æ›´æ–°
     */
    function updateModeSelector(categoryKey) {
        const config = CATEGORY_MAP[categoryKey];
        
        modeSelectorEl.innerHTML = '';
        
        // å…±é€šã®é¸æŠè‚¢
        const option1 = document.createElement('option');
        option1.value = '1';
        option1.textContent = 'â‘  è‹±æ–‡å…ˆè¡Œ';
        modeSelectorEl.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = '2';
        option2.textContent = 'â‘¡ éŸ³å£°å…ˆè¡Œ';
        modeSelectorEl.appendChild(option2);
        
        // é«˜æ ¡å—é¨“ã®ã¿æ–‡æ³•å•é¡Œã‚’è¿½åŠ 
        if (categoryKey.startsWith('highschool_')) {
            const option4 = document.createElement('option');
            option4.value = '4';
            option4.textContent = 'â‘¢ æ–‡æ³•å•é¡Œ';
            modeSelectorEl.appendChild(option4);
        }
        
        // ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰ãŒåˆ©ç”¨ä¸å¯ã«ãªã£ãŸå ´åˆã¯ãƒ¢ãƒ¼ãƒ‰1ã«ãƒªã‚»ãƒƒãƒˆ
        if (currentMode === 4 && !categoryKey.startsWith('highschool_')) {
            changeMode(1);
        } else {
            modeSelectorEl.value = currentMode;
        }
    }


    // â†“â†“â†“ ã“ã“ã‹ã‚‰æ–°è¦é–¢æ•°ã‚’è¿½åŠ  â†“â†“â†“
    
    /**
     * é«˜æ ¡å—é¨“ã®ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªé¸æŠç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹
     */
    function showHighSchoolSubcategories() {
        document.getElementById('main-category-buttons').classList.add('hidden');
        document.getElementById('highschool-subcategory-buttons').classList.remove('hidden');
        document.getElementById('selection-title').textContent = 'å­¦ç¿’ã™ã‚‹åˆ†é‡ã‚’é¸æŠã—ã¦ãã ã•ã„';
    }

    /**
     * ãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒªé¸æŠç”»é¢ã«æˆ»ã‚‹
     */
    function backToMainCategories() {
        document.getElementById('highschool-subcategory-buttons').classList.add('hidden');
        document.getElementById('main-category-buttons').classList.remove('hidden');
        document.getElementById('selection-title').textContent = 'å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é¸æŠã—ã¦ãã ã•ã„';
    }
    
    // â†‘â†‘â†‘ ã“ã“ã¾ã§æ–°è¦é–¢æ•°ã‚’è¿½åŠ  â†‘â†‘â†‘


    /**
     * ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
     */
    async function selectCategory(key, saveHistory = true) {
        if (!CATEGORY_MAP[key]) {
            showMessage('é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'danger');
            return;
        }

        clearMessage();

        currentCategoryKey = key;
        const config = CATEGORY_MAP[key];

        if (saveHistory) {
            localStorage.setItem('lastLearningCategory', key);
            localStorage.setItem('lastLearningMode', currentMode);
        }

        document.getElementById('selection-title').textContent = `${config.name}ã‚’èª­ã¿è¾¼ã¿ä¸­...`;

        try {
            const response = await fetch(config.jsonPath);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            ALL_DB = await response.json();

            // å­¦ç¿’æ¸ˆã¿ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ä»˜ä¸
            let learnedStatusMap = loadLearnedStatus();
            ALL_DB.forEach(item => {
                item.isLearned = !!learnedStatusMap[item.id];
            });

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            selectionScreenEl.classList.add('hidden');
            learningScreenEl.classList.remove('hidden');
            appHeaderEl.classList.remove('hidden');
            appFooterEl.classList.remove('hidden');
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–°
            document.querySelector('#app-header h1').textContent = config.name;

            // ãƒ¢ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®é¸æŠè‚¢ã‚’å‹•çš„ã«å¤‰æ›´
            updateModeSelector(key);

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åˆæœŸåŒ–
            setupSceneFilter(ALL_DB);
            setupGrammarTypeFilter(ALL_DB);
            
            // é«˜æ ¡å—é¨“ç”¨ã®å ´åˆã¯ä½¿ç”¨å ´é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            if (!config.hasSceneFilter) {
                currentSceneFilter = 'ALL';
            }
            
            // ã€ä¿®æ­£â‘¡ã€‘ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸæ™‚ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            clearMessage();
            
            // ãƒ¢ãƒ¼ãƒ‰ã‚’é©ç”¨
            applyAllFilters(); 

            if (currentMode === 4) {
                mainContentEl.classList.remove('grammar-layout-answered');
                mainContentEl.classList.add('overflow-y-auto');
            }

        } catch (error) {
            console.error("ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
            englishTextEl.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${config.jsonPath} ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            showMessage('ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ã€‚', 'danger');
            return;
        }
    }

    /**
     * å ´é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
     */
function setupSceneFilter(data) {
    const config = CATEGORY_MAP[currentCategoryKey];
    
    // é«˜æ ¡å—é¨“ç”¨ã®å ´åˆã¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’å®Œå…¨ã«éè¡¨ç¤º
    if (config && !config.hasSceneFilter) {
        sceneFilterContainerEl.style.display = 'none';
        currentSceneFilter = 'ALL'; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å€¤ã‚‚ãƒªã‚»ãƒƒãƒˆ
        return;
    }
    
    // æ—…è¡Œç”¨ã®å ´åˆã®ã¿è¡¨ç¤º
    sceneFilterContainerEl.style.display = 'flex';
    
    const categoryCounts = {};
    data.forEach(item => {
        const scene = item.category_main || 'ãã®ä»–';
        categoryCounts[scene] = (categoryCounts[scene] || 0) + 1;
    });

    const scenes = new Set(data.map(item => item.category_main).filter(c => c && c.trim() !== ''));
    const sortedScenes = Array.from(scenes).sort((a, b) => a.localeCompare(b, 'ja', { sensitivity: 'base' }));

    sceneFilterEl.innerHTML = '';
    const allOption = document.createElement('option');
    allOption.value = 'ALL';
    allOption.textContent = `å…¨ã¦ã®ä½¿ç”¨å ´é¢ (${data.length}ä»¶)`;
    sceneFilterEl.appendChild(allOption);

    sortedScenes.forEach(scene => {
        const option = document.createElement('option');
        option.value = scene;
        option.textContent = `${scene} (${categoryCounts[scene] || 0}ä»¶)`;
        sceneFilterEl.appendChild(option);
    });
    sceneFilterEl.value = currentSceneFilter; 
}

    /**
     * æ–‡æ³•é¡å‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹
     */
    function setupGrammarTypeFilter(data) {
        const grammarTypeCounts = {};
        data.filter(item => item.grammar_question).forEach(item => {
            const type = item.grammar_type || 'ãã®ä»–';
            grammarTypeCounts[type] = (grammarTypeCounts[type] || 0) + 1;
        });

        const grammarTypes = new Set(data.map(item => item.grammar_type).filter(c => c && c.trim() !== ''));
        const sortedTypes = Array.from(grammarTypes).sort((a, b) => a.localeCompare(b, 'ja', { sensitivity: 'base' }));

        grammarTypeSelectorEl.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = 'ALL';
        allOption.textContent = `å…¨ã¦ã®æ–‡æ³•é¡å‹`;
        grammarTypeSelectorEl.appendChild(allOption);

        sortedTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = `${type} (${grammarTypeCounts[type] || 0}ä»¶)`;
            grammarTypeSelectorEl.appendChild(option);
        });
        grammarTypeSelectorEl.value = currentGrammarType; 
    }


    /**
     * ç¾åœ¨ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®šã«åŸºã¥ããƒ‡ãƒ¼ã‚¿ã‚’çµã‚Šè¾¼ã‚€
     */
    function applyAllFilters() {
    const filterMode = filterModeSelectorEl.value;
    const isGrammarMode = currentMode === 4;
    const config = CATEGORY_MAP[currentCategoryKey];

    DB = ALL_DB.filter(item => {
        // å­¦ç¿’æ¸ˆã¿/æœªå­¦ç¿’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (filterMode === 'UNLEARNED' && item.isLearned) return false;
        if (filterMode === 'LEARNED' && !item.isLearned) return false;

        // ä½¿ç”¨å ´é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆæ—…è¡Œç”¨ã®ã¿ï¼‰
        if (config && config.hasSceneFilter) {
            if (currentSceneFilter !== 'ALL' && item.category_main !== currentSceneFilter) return false;
        }

        // æ–‡æ³•ãƒ¢ãƒ¼ãƒ‰å›ºæœ‰ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        if (isGrammarMode) {
            if (!item.grammar_question || item.grammar_question.trim() === '') return false;
            if (currentGrammarType !== 'ALL' && item.grammar_type !== currentGrammarType) return false;
        } 
        
        return true;
    });

        // æ–‡æ³•ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ã€ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
        mainContentEl.classList.toggle('overflow-y-auto', !isGrammarMode);

        // UIã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        englishDisplayCard.classList.toggle('hidden', isGrammarMode);
        
        // å’Œè¨³ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºåˆ¶å¾¡
        translationCardEl.classList.add('hidden');
        if (isGrammarMode) {
            translationCardEl.style.display = 'none'; 
        } else {
            translationCardEl.style.display = ''; 
        }
        
        grammarQuestionUiEl.classList.toggle('hidden', !isGrammarMode);
        // æ–‡æ³•å•é¡Œãƒ¢ãƒ¼ãƒ‰ã§ã‚‚ã€ã€Œè¦šãˆãŸã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
        toggleLearnedBtn.classList.remove('hidden'); // å¸¸ã«è¡¨ç¤º
        // å…¨ãƒ¢ãƒ¼ãƒ‰ã§å’Œè¨³è¡¨ç¤ºãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        toggleTranslationBtn.classList.remove('hidden');
        
        // ã€ä¿®æ­£â‘¡â‘¢â‘£ã€‘ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã¨éŸ³å£°ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (isGrammarMode) {
            // æ–‡æ³•å•é¡Œãƒ¢ãƒ¼ãƒ‰: ä½¿ç”¨å ´é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’éè¡¨ç¤ºã€æ–‡æ³•é¡å‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åŒã˜ä½ç½®ã«è¡¨ç¤º
            sceneFilterContainerEl.style.display = 'none';
            grammarTypeFilterContainerEl.style.display = 'flex';
            playAudioBtn.classList.add('hidden');
        } else {
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: ã‚«ãƒ†ã‚´ãƒªã«å¿œã˜ã¦ä½¿ç”¨å ´é¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®è¡¨ç¤ºã‚’åˆ¶å¾¡
            if (config && config.hasSceneFilter) {
                sceneFilterContainerEl.style.display = 'flex';
            } else {
                sceneFilterContainerEl.style.display = 'none';
            }
            grammarTypeFilterContainerEl.style.display = 'none';
            playAudioBtn.classList.remove('hidden');
        }

        if (DB.length === 0) {
            englishTextEl.textContent = 'é¸æŠã•ã‚ŒãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
            // ã€ä¿®æ­£â‘¡ã€‘ãƒ‡ãƒ¼ã‚¿ãŒ0ä»¶ã®æ™‚ã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (ALL_DB.length > 0) {
                showMessage('é¸æŠã•ã‚ŒãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'danger');
            } else {
                showMessage('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'danger');
            }
            progressIndicatorEl.textContent = '0/0';
            toggleLearnedBtn.classList.add('hidden');
            englishTextEl.classList.remove('italic', 'text-gray-400', 'blur-strong');
            translationCardEl.classList.add('hidden');
            return;
        }

        currentSentenceIndex = 0;
        loadSentence(currentSentenceIndex);
    }

    /**
     * ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
     */
    function changeMode(mode) {
        currentMode = parseInt(mode, 10);
        localStorage.setItem('lastLearningMode', currentMode);
        modeSelectorEl.value = currentMode;
        
        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ™‚ã®å’Œè¨³è¡¨ç¤ºçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
        isTranslationVisible = false;
        
        if (currentMode !== 4) {
            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆ1, 2ï¼‰
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none';
            japaneseTextEl.textContent = '';
            grammarTranslationCardEl.classList.add('hidden');
            grammarTranslationCardEl.style.display = 'none';
            grammarJapaneseTextEl.textContent = '';
            englishTextEl.classList.remove('blur-strong', 'italic', 'text-gray-400');
            
            if (currentMode === 1) { 
                toggleTranslationBtn.textContent = 'å’Œè¨³ã‚’è¡¨ç¤º';
            } else if (currentMode === 2) { 
                toggleTranslationBtn.textContent = 'è‹±æ–‡ãƒ»å’Œè¨³ã‚’è¡¨ç¤º';
            }
        } else {
            // æ–‡æ³•å•é¡Œãƒ¢ãƒ¼ãƒ‰ï¼ˆ4ï¼‰
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none';
            japaneseTextEl.textContent = '';
            grammarTranslationCardEl.classList.add('hidden');
            grammarTranslationCardEl.style.display = 'none';
            grammarJapaneseTextEl.textContent = '';
            toggleTranslationBtn.textContent = 'å’Œè¨³ã‚’è¡¨ç¤º';
        }

        mainContentEl.classList.remove('grammar-layout-answered');
        applyAllFilters();
        
        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆå¾Œã€å‰å›è¡¨ç¤ºã—ã¦ã„ãŸæ‹¡å¼µã®è‹±æ–‡ã‚’æ¢ç´¢ã™ã‚‹
        if (lastDisplayedId !== '') {
            const foundIndex = DB.findIndex(item => item.id === lastDisplayedId);
            if (foundIndex !== -1) {
                currentSentenceIndex = foundIndex;
                loadSentence(currentSentenceIndex);
            }
        }
    }

    /**
     * ç¾åœ¨ã®æ–‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’UIã«èª­ã¿è¾¼ã‚€
     */
    function loadSentence(index) {
        if (DB.length === 0) {
            progressIndicatorEl.textContent = '0/0';
            return;
        }

        currentSentenceIndex = (index + DB.length) % DB.length;
        const data = DB[currentSentenceIndex];

        // é€²æ—çŠ¶æ…‹ã‚’æ›´æ–°
        progressIndicatorEl.textContent = `${currentSentenceIndex + 1}/${DB.length}`;
        
        // ç¾åœ¨è¡¨ç¤ºä¸­ã®è‹±æ–‡IDã‚’è¨˜éŒ²
        lastDisplayedId = data.id;

        // è‹±æ–‡/å’Œè¨³è¡¨ç¤ºã‚¨ãƒªã‚¢ã®åˆ‡ã‚Šæ›¿ãˆã¨ãƒ‡ãƒ¼ã‚¿è¨­å®š
        if (currentMode === 4) { // æ–‡æ³•å•é¡Œãƒ¢ãƒ¼ãƒ‰
            mainContentEl.classList.remove('grammar-layout-answered');
            grammarTargetSentenceEl.textContent = data.grammar_question; // ç©ºæ¬„ã‚ã‚Šè‹±æ–‡
            // æ–‡æ³•å•é¡Œã®UIãƒªã‚»ãƒƒãƒˆ
            resetGrammarUI(data);
            
            // é€šå¸¸ã®å’Œè¨³ã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none'; // CSSã§ã‚‚ç¢ºå®Ÿã«éè¡¨ç¤º
            japaneseTextEl.textContent = '';
            
            // æ–‡æ³•UIã‚’è¡¨ç¤ºã—ã€é€šå¸¸è‹±æ–‡UIã‚’éè¡¨ç¤º
            englishDisplayCard.classList.add('hidden');
            grammarQuestionUiEl.classList.remove('hidden');

        } else { // è‹±æ–‡å…ˆè¡Œ(1) ã¾ãŸã¯ éŸ³å£°å…ˆè¡Œ(2)
            // è‹±æ–‡è¡¨ç¤ºã®ã‚»ãƒƒãƒˆ
            englishTextEl.textContent = data.en;

            // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸè‹±æ–‡è¡¨ç¤ºã®èª¿æ•´ (ã¼ã‹ã—)
            if (currentMode === 1) { 
                englishTextEl.classList.remove('blur-strong', 'italic', 'text-gray-400');
                toggleTranslationBtn.textContent = 'å’Œè¨³ã‚’è¡¨ç¤º';
            } else if (currentMode === 2) { 
                englishTextEl.classList.add('blur-strong'); 
                englishTextEl.classList.remove('italic', 'text-gray-400');
                toggleTranslationBtn.textContent = 'è‹±æ–‡ãƒ»å’Œè¨³ã‚’è¡¨ç¤º';
            }

            // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯å’Œè¨³ã‚’éè¡¨ç¤º
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none';
            grammarTranslationCardEl.classList.add('hidden'); 
            isTranslationVisible = false;
            japaneseTextEl.textContent = '';
            
            // æ–‡æ³•UIã¯éè¡¨ç¤ºã«
            englishDisplayCard.classList.remove('hidden');
            grammarQuestionUiEl.classList.add('hidden');
        }

        // å­¦ç¿’æ¸ˆã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        updateLearnedStatusUI(data.isLearned);
        
        // å‡ºå…¸æƒ…å ±ã‚’æ›´æ–°
        updateSourceCitation(data);
    }

    /**
     * å‰å¾Œã¸ç§»å‹•ã™ã‚‹
     */
    function navigate(direction) {
        loadSentence(currentSentenceIndex + direction);
        
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯å’Œè¨³ã‚’ãƒªã‚»ãƒƒãƒˆ
        if (currentMode !== 4) {
            isTranslationVisible = false;
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none';
            japaneseTextEl.textContent = '';
            toggleTranslationBtn.textContent = currentMode === 1 ? 'å’Œè¨³ã‚’è¡¨ç¤º' : 'è‹±æ–‡ãƒ»å’Œè¨³ã‚’è¡¨ç¤º';
        } else {
            // æ–‡æ³•ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯å’Œè¨³ã‚’ãƒªã‚»ãƒƒãƒˆ
            isTranslationVisible = false;
            grammarTranslationCardEl.classList.add('hidden');
            grammarTranslationCardEl.style.display = 'none';
            grammarJapaneseTextEl.textContent = '';
            toggleTranslationBtn.textContent = 'å’Œè¨³ã‚’è¡¨ç¤º';
            resetGrammarUI(DB[currentSentenceIndex]);
        }

        // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸè‹±æ–‡è¡¨ç¤ºã®èª¿æ•´ï¼ˆloadSentenceã§æ—¢ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ä¸è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒä¿æŒï¼‰
        if (currentMode === 1) { 
            englishTextEl.classList.remove('blur-strong', 'italic', 'text-gray-400');
        } else if (currentMode === 2) { 
            englishTextEl.classList.add('blur-strong'); 
            englishTextEl.classList.remove('italic', 'text-gray-400');
        }
        
        // ç¾åœ¨è¡¨ç¤ºä¸­ã®è‹±æ–‡IDã‚’è¨˜éŒ²
        lastDisplayedId = DB[currentSentenceIndex].id;
    }


    // --- å­¦ç¿’æ¸ˆã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç† (çœç•¥) ---
    function loadLearnedStatus() {
        const json = localStorage.getItem(LEARNED_STATUS_KEY);
        return json ? JSON.parse(json) : {};
    }

    function saveLearnedStatus(statusMap) {
        localStorage.setItem(LEARNED_STATUS_KEY, JSON.stringify(statusMap));
    }

    function toggleLearnedStatus() {
        if (DB.length === 0) return;

        const currentId = DB[currentSentenceIndex].id;
        let learnedStatusMap = loadLearnedStatus();
        const isCurrentlyLearned = !!learnedStatusMap[currentId];

        if (isCurrentlyLearned) {
            delete learnedStatusMap[currentId];
            DB[currentSentenceIndex].isLearned = false;
            showMessage('æœªå­¦ç¿’ã«æˆ»ã—ã¾ã—ãŸã€‚', 'gray');
        } else {
            learnedStatusMap[currentId] = true;
            DB[currentSentenceIndex].isLearned = true;
            showMessage('ã€Œè¦šãˆãŸã€ã¨ã—ã¦ãƒãƒ¼ã‚¯ã—ã¾ã—ãŸï¼', 'secondary');
        }
        saveLearnedStatus(learnedStatusMap);
        updateLearnedStatusUI(DB[currentSentenceIndex].isLearned);
        
        if (filterModeSelectorEl.value !== 'ALL') {
            applyAllFilters();
        }
    }

    function updateLearnedStatusUI(isLearned) {
        if (isLearned) {
            toggleLearnedBtn.classList.remove('bg-secondary', 'hover:bg-emerald-600');
            toggleLearnedBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            toggleLearnedBtn.textContent = 'æœªå­¦ç¿’ã«æˆ»ã™';
        } else {
            toggleLearnedBtn.classList.add('bg-secondary', 'hover:bg-emerald-600');
            toggleLearnedBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            toggleLearnedBtn.textContent = 'âœ“ è¦šãˆãŸ';
        }
    }

    /**
     * å‡ºå…¸æƒ…å ±ã‚’è¡¨ç¤ºã™ã‚‹
     */
    function updateSourceCitation(data) {
        // é«˜æ ¡å—é¨“ã‚«ãƒ†ã‚´ãƒªä»¥å¤–ã§ã¯éè¡¨ç¤º
        if (!currentCategoryKey.startsWith('highschool_')) {
            sourceCitationEl.classList.add('hidden');
            grammarSourceCitationEl.classList.add('hidden');
            return;
        }
        
        // å¹´åº¦ã¨éƒ½é“åºœçœŒã®æƒ…å ±ã‚’å–å¾—
        const year = data.year || '';
        const prefecture = data.prefecture || '';
        
        if (!year && !prefecture) {
            sourceCitationEl.classList.add('hidden');
            grammarSourceCitationEl.classList.add('hidden');
            return;
        }
        
        // éƒ½é“åºœçœŒåã®å¾Œã«é©åˆ‡ãªæ¥å°¾è¾ã‚’ä»˜ã‘ã‚‹
        let prefectureSuffix = '';
        if (prefecture) {
            // ã€Œéƒ½ã€ã€Œé“ã€ã€Œåºœã€ã€ŒçœŒã€ãŒæ—¢ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            if (!prefecture.match(/[éƒ½é“åºœçœŒ]$/)) {
                // æ±äº¬ã€åŒ—æµ·é“ã€å¤§é˜ªã€äº¬éƒ½ã®ç‰¹æ®Šã‚±ãƒ¼ã‚¹
                if (prefecture === 'æ±äº¬') {
                    prefectureSuffix = 'éƒ½';
                } else if (prefecture === 'åŒ—æµ·é“') {
                    prefectureSuffix = '';
                } else if (prefecture === 'å¤§é˜ª' || prefecture === 'äº¬éƒ½') {
                    prefectureSuffix = 'åºœ';
                } else {
                    prefectureSuffix = 'çœŒ';
                }
            }
        }
        
        // å‡ºå…¸ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰
        const citationText = `å‡ºå…¸ï¼š${year}å¹´${prefecture}${prefectureSuffix}é«˜æ ¡è‹±èªå…¥è©¦å•é¡Œ`;
        
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¨æ–‡æ³•å•é¡Œãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (currentMode === 4) {
            grammarSourceCitationEl.textContent = citationText;
            grammarSourceCitationEl.classList.remove('hidden');
            sourceCitationEl.classList.add('hidden');
        } else {
            sourceCitationEl.textContent = citationText;
            sourceCitationEl.classList.remove('hidden');
            grammarSourceCitationEl.classList.add('hidden');
        }
    }


    // --- å’Œè¨³ãƒ»éŸ³å£°å†ç”Ÿ (çœç•¥) ---

    function toggleTranslation() {
        // æ–‡æ³•å•é¡Œãƒ¢ãƒ¼ãƒ‰ã§ã®å‡¦ç†
        if (currentMode === 4) {
            isTranslationVisible = !isTranslationVisible;
            
            if (isTranslationVisible) {
                grammarTranslationCardEl.classList.remove('hidden');
                grammarTranslationCardEl.style.display = 'flex'; // ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹è¡¨ç¤ºã«
                grammarJapaneseTextEl.textContent = DB[currentSentenceIndex].ja;
                toggleTranslationBtn.textContent = 'å’Œè¨³ã‚’éè¡¨ç¤º';
            } else {
                grammarTranslationCardEl.classList.add('hidden');
                grammarTranslationCardEl.style.display = 'none'; // å®Œå…¨éè¡¨ç¤º
                grammarJapaneseTextEl.textContent = '';
                toggleTranslationBtn.textContent = 'å’Œè¨³ã‚’è¡¨ç¤º';
            }
            return; 
        }

        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ¢ãƒ¼ãƒ‰1, 2ï¼‰ã§ã®å‡¦ç†
        isTranslationVisible = !isTranslationVisible;
        
        // å’Œè¨³è¡¨ç¤ºæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        if (isTranslationVisible) {
            translationCardEl.classList.remove('hidden');
            translationCardEl.style.display = 'flex'; // ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹è¡¨ç¤ºã«
            japaneseTextEl.textContent = DB[currentSentenceIndex].ja;
            toggleTranslationBtn.textContent = 'å’Œè¨³ã‚’éè¡¨ç¤º';
            
            if (currentMode === 2) {
                englishTextEl.classList.remove('blur-strong');
                englishTextEl.classList.remove('italic', 'text-gray-400');
            }

        } else {
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none'; // å®Œå…¨éè¡¨ç¤º
            japaneseTextEl.textContent = ''; 
            toggleTranslationBtn.textContent = currentMode === 1 ? 'å’Œè¨³ã‚’è¡¨ç¤º' : 'è‹±æ–‡ãƒ»å’Œè¨³ã‚’è¡¨ç¤º'; 
            
            if (currentMode === 2) {
                englishTextEl.classList.add('blur-strong');
            }
        }
    }

    function playAudio() {
        const data = DB[currentSentenceIndex];
        const config = CATEGORY_MAP[currentCategoryKey];
        if (!data || !config) return;

        const audioFileName = data.id + '.mp3';
        const audioPath = `./audio/${config.audioFolder}/${audioFileName}`;
        
        const audio = new Audio(audioPath);
        audio.play().catch(error => {
            console.error("éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:", error, audioPath);
            showMessage('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„ã‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã§ã™ã€‚', 'danger');
        });
    }


    // --- æ–‡æ³•å•é¡Œãƒ¢ãƒ¼ãƒ‰é–¢é€£ ---

    /**
     * æ–‡æ³•å•é¡Œã®UIã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
     */
    function resetGrammarUI(data) {
        grammarQuestionTextEl.textContent = '(ç©ºæ¬„ã«å½“ã¦ã¯ã¾ã‚‹å˜èªã‚’é¸ã‚“ã§ãã ã•ã„)'; 
        grammarAnswerExplanationEl.classList.add('hidden');
        mainContentEl.classList.remove('grammar-layout-answered');
        mainContentEl.classList.add('overflow-y-auto');
        
        // ä¸¡æ–¹ã®å’Œè¨³ã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤ºã«çµ±ä¸€ï¼ˆãƒœã‚¿ãƒ³ã§è¡¨ç¤ºã•ã›ã‚‹ã¾ã§è¡¨ç¤ºã—ãªã„ï¼‰
        translationCardEl.classList.add('hidden');
        translationCardEl.style.display = 'none'; // CSSã§ã‚‚éè¡¨ç¤º
        grammarTranslationCardEl.classList.add('hidden'); 
        grammarTranslationCardEl.style.display = 'none'; // CSSã§ã‚‚éè¡¨ç¤º
        japaneseTextEl.textContent = '';
        grammarJapaneseTextEl.textContent = ''; 
        isTranslationVisible = false;

        const allLetters = ['A', 'B', 'C', 'D'];
        
        // é¸æŠè‚¢ã®ãƒ†ã‚­ã‚¹ãƒˆè¨­å®šã¨UIãƒªã‚»ãƒƒãƒˆ
        allLetters.forEach(letter => {
            const buttonEl = document.getElementById(`choice-${letter}`);
            const choiceKey = 'grammar_choice_' + letter.toLowerCase();
            const choiceTextWithLetter = data[choiceKey];

            if (choiceTextWithLetter) {
                const choiceText = choiceTextWithLetter.substring(3).trim(); 
                buttonEl.textContent = choiceText;
                buttonEl.setAttribute('onclick', `checkGrammarAnswer('${letter}')`);
                buttonEl.disabled = false;
                buttonEl.classList.remove('bg-green-100', 'bg-red-100', 'border-green-500', 'border-red-500', 'selected', 'opacity-50', 'hidden');
                buttonEl.classList.add('bg-gray-100', 'border-gray-300');
            } else {
                buttonEl.classList.add('hidden');
            }
        });
    }


    /**
     * æ–‡æ³•å•é¡Œã®å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹
     */
    function checkGrammarAnswer(selectedLetter) {
        const data = DB[currentSentenceIndex];
        const correctChoiceWithLetter = data.grammar_answer; 
        const correctLetter = correctChoiceWithLetter.substring(0, 1); 
        
        const isCorrect = selectedLetter === correctLetter;

        grammarQuestionTextEl.textContent = '';

        // å›ç­”é¸æŠè‚¢ã®UIã‚’æ›´æ–°
        const selectedButton = document.getElementById(`choice-${selectedLetter}`);
        const correctButton = document.getElementById(`choice-${correctLetter}`);

        // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        document.querySelectorAll('#grammar-choices button').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-50');
        });

        if (isCorrect) {
            // æ­£è§£ã®å ´åˆ
            selectedButton.classList.remove('bg-gray-100', 'border-gray-300', 'bg-red-100', 'border-red-500');
            selectedButton.classList.add('bg-green-100', 'border-green-500');
        } else {
            // ä¸æ­£è§£ã®å ´åˆ
            selectedButton.classList.remove('bg-gray-100', 'border-gray-300');
            selectedButton.classList.add('bg-red-100', 'border-red-500');

            // æ­£è§£ã®ãƒœã‚¿ãƒ³ã‚’ç·‘è‰²ã§è¡¨ç¤º
            if (correctButton) {
                correctButton.classList.remove('bg-gray-100', 'border-gray-300', 'opacity-50');
                correctButton.classList.add('bg-green-100', 'border-green-500');
                correctButton.disabled = true; 
            }
        }

        // è§£èª¬ã‚’è¡¨ç¤º
        grammarCorrectAnswerEl.textContent = correctChoiceWithLetter;
        grammarExplanationTextEl.textContent = data.grammar_explanation || 'è§£èª¬ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        grammarAnswerExplanationEl.classList.remove('hidden');

        // å’Œè¨³ã‚«ãƒ¼ãƒ‰ã‚’å¸¸ã«è¡¨ç¤ºï¼ˆå›ç­”å¾Œã¯å¿…ãšå’Œè¨³ã‚’è¦‹ã›ã‚‹ï¼‰
        grammarJapaneseTextEl.textContent = data.ja;
        grammarTranslationCardEl.classList.remove('hidden');
        grammarTranslationCardEl.style.display = 'flex'; // ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹è¡¨ç¤ºã«
        isTranslationVisible = true;

        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å›ç­”å¾Œã‚¹ã‚¿ã‚¤ãƒ«ã«åˆ‡ã‚Šæ›¿ãˆ
        mainContentEl.classList.remove('overflow-y-auto');
        mainContentEl.classList.add('grammar-layout-answered');
    }
    
    /**
     * æ–‡æ³•é¡å‹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹
     */
    function filterByType(type) {
        currentGrammarType = type;
        applyAllFilters();
    }
    
    /**
     * ä½¿ç”¨å ´é¢ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹
     */
    function filterScenes(scene) {
        currentSceneFilter = scene;
        applyAllFilters();
    }


    // --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º (çœç•¥) ---

    function clearMessage() {
        if (messageTimeoutId) {
            clearTimeout(messageTimeoutId);
        }
        messageBoxEl.classList.add('hidden');
        messageBoxEl.textContent = '';
    }

    function showMessage(text, type) {
        clearMessage();
        
        messageBoxEl.textContent = text;
        messageBoxEl.className = `text-center py-2 px-4 text-lg font-semibold rounded-lg shadow-sm mt-4`;
        
        let bgColor, textColor;
        switch (type) {
            case 'secondary': bgColor = 'bg-emerald-200'; textColor = 'text-emerald-800'; break; 
            case 'danger': bgColor = 'bg-red-200'; textColor = 'text-red-800'; break;
            case 'primary': bgColor = 'bg-indigo-200'; textColor = 'text-indigo-800'; break; 
            case 'gray': bgColor = 'bg-gray-200'; textColor = 'text-gray-800'; break;
            default: bgColor = 'bg-gray-200'; textColor = 'text-gray-800'; break;
        }
        messageBoxEl.classList.add(bgColor, textColor);
        messageBoxEl.classList.remove('hidden');

        messageTimeoutId = setTimeout(() => {
            messageBoxEl.classList.add('hidden');
        }, 3000);
    }
</script>
</body>
</html>