<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語学習サイト</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムフォントとして日本語表示に適したInterを設定 */
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        /* 画面全体にフィットし、スクロールを発生させないためのスタイル */
        .h-screen-no-scroll { height: 100vh; overflow: hidden; }
        .word-button { transition: all 0.2s; }
        .word-button:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .selected { opacity: 0.5; pointer-events: none; }
        /* 音声先行モード用の強いぼかし */
        .blur-strong { filter: blur(8px); }
        
        /* 文法問題の選択肢のホバー効果 */
        .choice-button:not(:disabled):hover { 
            background-color: #f3f4f6; /* gray-100 */
            border-color: #4f46e5; /* primary-600 */
        }

        /* 英文先行・音声先行モードの和訳カード */
        #translation-card { 
            display: flex;
            flex-direction: column; 
            padding: 16px; /* p-4 */
            min-height: 100px; /* 最小の高さを確保 */
        }
        #translation-card .flex-content-center { 
            display: flex;
            align-items: center; 
            justify-content: center; 
            flex-grow: 1; 
        }
        #translation-card .translation-label {
            align-self: flex-start;
            margin-bottom: 4px; 
        }
        #translation-card #japanese-text {
            min-height: 1.5rem;
        }

        /* 文法問題モードの和訳カードのスタイル調整 */
        #grammar-translation-card { 
            display: flex;
            flex-direction: column; 
            padding: 16px; /* p-4 */
        }
        #grammar-translation-card .flex-content-center {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-grow: 1;
        }
        #grammar-translation-card .translation-label {
            align-self: flex-start;
            margin-bottom: 8px; 
            padding-left: 4px; 
        }
        #grammar-translation-card #grammar-japanese-text {
            min-height: 1.5rem;
        }

        /* 文法問題モードの回答後のレイアウト調整 */
        .grammar-layout-answered {
            display: flex;
            flex-direction: column;
            gap: 12px; /* 12px */
            overflow-y: auto; 
            height: 100%; 
        }

        /* 選択肢を横一列に強制的に並べるためのスタイル調整 */
        .choice-button {
            flex: 1 1 0%; 
            min-width: 0;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // スタイリッシュテーマのカラー定義
                        'primary': '#4f46e5', // Indigo-600
                        'secondary': '#10b981', // Emerald-500
                        'danger': '#ef4444',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 h-screen-no-scroll flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-4xl bg-white shadow-2xl rounded-xl flex flex-col h-full md:h-5/6 overflow-hidden">

        <header id="app-header" class="p-6 bg-primary text-white rounded-t-xl shadow-lg flex flex-col md:flex-row justify-between items-center hidden">
            <h1 class="text-2xl font-bold tracking-tight mb-3 md:mb-0">海外旅行で便利なフレーズ</h1>
            
            <div class="flex flex-wrap justify-center items-center space-x-4 mt-3 md:mt-0">
                
                <div class="flex items-center space-x-2">
                    <label for="filter-mode-selector" class="text-sm font-medium">表示:</label>
                    <select id="filter-mode-selector" onchange="applyAllFilters()" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        <option value="ALL">全ての英文</option>
                        <option value="UNLEARNED">未学習のみ</option>
                        <option value="LEARNED">学習済のみ</option>
                    </select>
                </div>

                <div class="flex items-center space-x-2 mt-2 md:mt-0">
                    <label for="mode-selector" class="text-sm font-medium">学習モード:</label>
                    <select id="mode-selector" onchange="changeMode(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        <option value="1">① 英文先行</option>
                        <option value="2">② 音声先行</option>
                        <option value="4">③ 文法問題</option>
                    </select>
                </div>
                
            </div>
        </header>

        <main id="main-content" class="flex-grow p-6 flex flex-col space-y-3 overflow-y-auto">

            <div id="selection-screen" class="p-12 flex flex-col items-center justify-center h-full text-center">
                <h2 id="selection-title" class="text-3xl font-extrabold text-gray-800 mb-8">学習コンテンツを選択してください</h2>
                
                <div id="main-category-buttons" class="space-y-6 w-full max-w-md">
                    <button id="btn-travel" onclick="selectCategory('travel')" class="w-full py-4 bg-primary text-white text-xl font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition-colors duration-200 transform hover:scale-[1.02]">
                        ✈️ 旅行用英語
                    </button>
                    </div>
            </div>
            
            <div id="learning-screen" class="hidden flex-grow flex flex-col space-y-3">
                
                <div class="text-center text-sm text-gray-500 mb-2 flex justify-between items-center">
                    
                    <span id="progress-indicator" class="px-2 py-1 rounded-md text-gray-600 font-semibold"></span>

                    <div id="scene-filter-container" class="flex items-center space-x-2">
                        <label for="scene-filter" class="text-sm font-medium text-gray-600">使用場面:</label>
                        <select id="scene-filter" onchange="filterScenes(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary"></select>
                    </div>

                    <div id="grammar-type-filter-container" class="flex items-center space-x-2 hidden">
                        <label for="grammar-type-selector" class="text-sm font-medium text-gray-600">文法類型:</label>
                        <select id="grammar-type-selector" onchange="filterByType(this.value)" class="text-gray-800 px-3 py-1 rounded-lg font-medium text-sm transition duration-200 focus:ring-primary focus:border-primary">
                        </select>
                    </div>

                </div>
    
                <div id="english-display-card" class="bg-indigo-50 p-6 rounded-xl shadow-inner min-h-[100px] flex items-center justify-center transition-all duration-300">
                    <p id="english-text" class="text-xl md:text-2xl font-bold text-gray-800 text-center select-none w-full">
                        </p>
                </div>
    
                <div id="translation-card" class="bg-white border border-gray-200 rounded-xl shadow min-h-[60px] transition-all duration-300 hidden">
                    <p class="translation-label text-sm font-semibold text-gray-600">和訳</p>
                    <div id="translation-content" class="flex-content-center">
                        <p id="japanese-text" class="text-lg text-gray-700 text-center w-full">
                            </p>
                    </div>
                </div>

                <div id="grammar-question-ui" class="hidden flex-col space-y-3 pt-2 flex-grow">

                    <div id="grammar-sentence-card" class="bg-indigo-50 p-6 rounded-xl shadow-inner min-h-[80px] flex items-center justify-center transition-all duration-300">
                        <p id="grammar-target-sentence" class="text-xl md:text-2xl font-bold text-gray-800 text-center select-none">
                            </p>
                    </div>
                    
                    <div id="grammar-translation-card" class="bg-white border border-gray-200 rounded-xl shadow min-h-[60px] transition-all duration-300 hidden">
                        <p class="translation-label text-sm font-semibold text-gray-600">和訳</p>
                        <div id="grammar-translation-content" class="flex-content-center">
                            <p id="grammar-japanese-text" class="text-lg text-gray-700 text-center w-full">
                                </p>
                        </div>
                    </div>

                    <p id="grammar-question-text" class="text-xl font-bold text-gray-800 text-center px-4"></p>


                    <div id="grammar-choices" class="flex justify-between gap-2 pt-2 mx-auto w-full"> 
                        <button id="choice-A" onclick="checkGrammarAnswer('A')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button> 
                        <button id="choice-B" onclick="checkGrammarAnswer('B')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                        <button id="choice-C" onclick="checkGrammarAnswer('C')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                        <button id="choice-D" onclick="checkGrammarAnswer('D')" onclick="checkGrammarAnswer('D')" class="choice-button py-2 px-3 rounded-lg text-base text-left bg-gray-100 border border-gray-300 transition duration-150"></button>
                    </div>

                    <div id="grammar-answer-explanation" class="hidden mt-4 p-3 rounded-xl shadow-xl bg-white border-2 border-green-500 max-w-xl mx-auto w-full flex-shrink-0">
                        <p class="font-bold text-green-700 mb-1 border-b border-green-200 pb-1">【正解】<span id="grammar-correct-answer" class="font-extrabold"></span></p>
                        <p class="font-bold text-gray-700 mt-2 mb-1">【解説】</p>
                        <p id="grammar-explanation-text" class="text-gray-600 text-sm"></p>
                    </div>
                </div>

                <div id="message-box" class="text-center py-2 text-lg font-semibold hidden rounded-lg"></div>
            </div>

        </main>

        <footer id="app-footer" class="p-6 bg-gray-100 rounded-b-xl border-t border-gray-200 flex justify-between items-center flex-wrap hidden">
            <div class="flex space-x-2">
                <button onclick="navigate(-1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    &lt; 前の文
                </button>
                <button onclick="navigate(1)" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium">
                    次の文 &gt;
                </button>
            </div>
            
            <button onclick="showSelectionScreen()" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors font-medium mt-4 md:mt-0">
                TOP画面
            </button>

            <div class="flex space-x-3 mt-4 md:mt-0">
                
                <button id="toggle-learned-btn" onclick="toggleLearnedStatus()" class="px-6 py-2 bg-secondary text-white font-bold rounded-lg hover:bg-emerald-600 transition-colors shadow-md flex items-center">
                    ✓ 覚えた
                </button>
                
                <button id="toggle-translation-btn" onclick="toggleTranslation()" class="px-6 py-2 bg-primary text-white font-bold rounded-lg hover:bg-indigo-700 transition-colors shadow-md">
                    和訳を表示
                </button>

                <button id="play-audio-btn" onclick="playAudio()" class="px-6 py-2 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition-colors shadow-md flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 108 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                    音声再生
                </button>
            </div>
        </footer>

    </div>

<script>
    // --- グローバル変数と定数 ---
    let ALL_DB = []; 
    let DB = []; 
    let currentMode = 1; 
    let currentSentenceIndex = 0;
    let isTranslationVisible = false; 
    let currentCategoryKey = ''; 
    const LEARNED_STATUS_KEY = 'learning_app_learned_status';
    let messageTimeoutId = null;
    let currentGrammarType = 'ALL';
    let currentSceneFilter = 'ALL'; 

    // JSONパスと対応する音声フォルダを定義
    const CATEGORY_MAP = {
        'travel': {
            jsonPath: './data/travel_sentences.json',
            audioFolder: 'travel',
            name: '旅行用英語',
        },
    };

    // --- DOM要素の参照 ---
    const appHeaderEl = document.getElementById('app-header');
    const appFooterEl = document.getElementById('app-footer');
    const selectionScreenEl = document.getElementById('selection-screen');
    const learningScreenEl = document.getElementById('learning-screen');
    const mainContentEl = document.getElementById('main-content');
    const filterModeSelectorEl = document.getElementById('filter-mode-selector');
    const toggleLearnedBtn = document.getElementById('toggle-learned-btn');
    const toggleTranslationBtn = document.getElementById('toggle-translation-btn');
    const englishTextEl = document.getElementById('english-text');
    const japaneseTextEl = document.getElementById('japanese-text');
    const translationCardEl = document.getElementById('translation-card'); // 通常モードの和訳カード
    const progressIndicatorEl = document.getElementById('progress-indicator');
    const sceneFilterEl = document.getElementById('scene-filter');
    const modeSelectorEl = document.getElementById('mode-selector');
    const englishDisplayCard = document.getElementById('english-display-card');
    const grammarQuestionUiEl = document.getElementById('grammar-question-ui');
    const grammarTargetSentenceEl = document.getElementById('grammar-target-sentence');
    const grammarQuestionTextEl = document.getElementById('grammar-question-text');
    const grammarChoicesEl = document.getElementById('grammar-choices');
    const grammarAnswerExplanationEl = document.getElementById('grammar-answer-explanation');
    const grammarCorrectAnswerEl = document.getElementById('grammar-correct-answer');
    const grammarExplanationTextEl = document.getElementById('grammar-explanation-text');
    const messageBoxEl = document.getElementById('message-box');
    const grammarTypeSelectorEl = document.getElementById('grammar-type-selector');
    const grammarTranslationCardEl = document.getElementById('grammar-translation-card'); // 文法問題モードの和訳カード
    const grammarJapaneseTextEl = document.getElementById('grammar-japanese-text');
    const sceneFilterContainerEl = document.getElementById('scene-filter-container');
    const grammarTypeFilterContainerEl = document.getElementById('grammar-type-filter-container');
    const playAudioBtn = document.getElementById('play-audio-btn');

    // --- 初期化処理 ---

    document.addEventListener('DOMContentLoaded', () => {
        clearMessage(); 

        const lastCategory = localStorage.getItem('lastLearningCategory');
        const lastMode = localStorage.getItem('lastLearningMode');

        if (lastCategory && CATEGORY_MAP[lastCategory]) {
            selectCategory(lastCategory, false);
            if (lastMode) {
                changeMode(lastMode);
            }
        }
    });

    /**
     * カテゴリ選択画面を表示する
     */
    function showSelectionScreen() {
        appHeaderEl.classList.add('hidden');
        appFooterEl.classList.add('hidden');
        learningScreenEl.classList.add('hidden');
        selectionScreenEl.classList.remove('hidden');
        mainContentEl.classList.remove('grammar-layout-answered');
        mainContentEl.classList.add('overflow-y-auto'); 
        document.getElementById('selection-title').textContent = '学習コンテンツを選択してください';
        currentCategoryKey = '';
        currentSceneFilter = 'ALL'; 
        currentGrammarType = 'ALL'; 
        // 通常モードの和訳カードを非表示に
        translationCardEl.classList.add('hidden'); 
    }

    /**
     * カテゴリを選択し、データを読み込む
     */
    async function selectCategory(key, saveHistory = true) {
        if (!CATEGORY_MAP[key]) {
            showMessage('選択されたカテゴリが見つかりません。', 'danger');
            return;
        }

        currentCategoryKey = key;
        const config = CATEGORY_MAP[key];

        if (saveHistory) {
            localStorage.setItem('lastLearningCategory', key);
            localStorage.setItem('lastLearningMode', currentMode);
        }

        document.getElementById('selection-title').textContent = `${config.name}を読み込み中...`;

        try {
            const response = await fetch(config.jsonPath);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            ALL_DB = await response.json();

            // 学習済みのステータスを付与
            let learnedStatusMap = loadLearnedStatus();
            ALL_DB.forEach(item => {
                item.isLearned = !!learnedStatusMap[item.id];
            });

            // 画面切り替え
            selectionScreenEl.classList.add('hidden');
            learningScreenEl.classList.remove('hidden');
            appHeaderEl.classList.remove('hidden');
            appFooterEl.classList.remove('hidden');
            
            // ヘッダータイトルの更新
            document.querySelector('#app-header h1').textContent = config.name;

            // フィルターを初期化
            setupSceneFilter(ALL_DB);
            setupGrammarTypeFilter(ALL_DB);
            
            // モードを適用
            applyAllFilters(); 

            if (currentMode === 4) {
                mainContentEl.classList.remove('grammar-layout-answered');
                mainContentEl.classList.add('overflow-y-auto');
            }

        } catch (error) {
            console.error("データの読み込みまたは初期化に失敗しました:", error);
            englishTextEl.textContent = `エラーが発生しました: ${config.jsonPath} の読み込みまたはデータ初期化に失敗しました。詳細をブラウザのコンソールで確認してください。`;
            showMessage('データファイルの読み込みまたは初期化エラー。', 'danger');
            return;
        }
    }

    /**
     * 場面フィルターをセットアップする
     */
    function setupSceneFilter(data) {
        const categoryCounts = {};
        data.forEach(item => {
            const scene = item.category_main || 'その他';
            categoryCounts[scene] = (categoryCounts[scene] || 0) + 1;
        });

        const scenes = new Set(data.map(item => item.category_main).filter(c => c && c.trim() !== ''));
        const sortedScenes = Array.from(scenes).sort((a, b) => a.localeCompare(b, 'ja', { sensitivity: 'base' }));

        sceneFilterEl.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = 'ALL';
        allOption.textContent = `全ての使用場面 (${data.length}件)`;
        sceneFilterEl.appendChild(allOption);

        sortedScenes.forEach(scene => {
            const option = document.createElement('option');
            option.value = scene;
            option.textContent = `${scene} (${categoryCounts[scene] || 0}件)`;
            sceneFilterEl.appendChild(option);
        });
        sceneFilterEl.value = currentSceneFilter; 
    }

    /**
     * 文法類型フィルターをセットアップする
     */
    function setupGrammarTypeFilter(data) {
        const grammarTypeCounts = {};
        data.filter(item => item.grammar_question).forEach(item => {
            const type = item.grammar_type || 'その他';
            grammarTypeCounts[type] = (grammarTypeCounts[type] || 0) + 1;
        });

        const grammarTypes = new Set(data.map(item => item.grammar_type).filter(c => c && c.trim() !== ''));
        const sortedTypes = Array.from(grammarTypes).sort((a, b) => a.localeCompare(b, 'ja', { sensitivity: 'base' }));

        grammarTypeSelectorEl.innerHTML = '';
        const allOption = document.createElement('option');
        allOption.value = 'ALL';
        allOption.textContent = `全ての文法類型`;
        grammarTypeSelectorEl.appendChild(allOption);

        sortedTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type;
            option.textContent = `${type} (${grammarTypeCounts[type] || 0}件)`;
            grammarTypeSelectorEl.appendChild(option);
        });
        grammarTypeSelectorEl.value = currentGrammarType; 
    }


    /**
     * 現在のフィルター設定に基づきデータを絞り込む
     */
    function applyAllFilters() {
        const filterMode = filterModeSelectorEl.value;
        const isGrammarMode = currentMode === 4;

        DB = ALL_DB.filter(item => {
            // 学習済み/未学習フィルター
            if (filterMode === 'UNLEARNED' && item.isLearned) return false;
            if (filterMode === 'LEARNED' && !item.isLearned) return false;

            // 使用場面フィルター
            if (currentSceneFilter !== 'ALL' && item.category_main !== currentSceneFilter) return false;

            // 文法モード固有のフィルター
            if (isGrammarMode) {
                // 文法問題データがないものは除外
                if (!item.grammar_question || item.grammar_question.trim() === '') return false;
                
                // 文法類型フィルターを適用
                if (currentGrammarType !== 'ALL' && item.grammar_type !== currentGrammarType) return false;
            } 
            
            return true;
        });

        // 文法モードの場合は、メインコンテンツにスタイルを適用
        mainContentEl.classList.toggle('overflow-y-auto', !isGrammarMode);

        // UIの表示/非表示を切り替え
        englishDisplayCard.classList.toggle('hidden', isGrammarMode);
        
        // 【修正】通常の和訳カードも文法モードでは確実に非表示
        translationCardEl.classList.add('hidden');
        if (isGrammarMode) {
            translationCardEl.style.display = 'none'; // CSSでも非表示
        } else {
            translationCardEl.style.display = ''; // 通常モードでは表示可能に戻す
        }
        
        grammarQuestionUiEl.classList.toggle('hidden', !isGrammarMode);
        toggleLearnedBtn.classList.toggle('hidden', isGrammarMode);
        toggleTranslationBtn.classList.toggle('hidden', isGrammarMode);
        
        // 【修正③④⑤】モードに応じてフィルターと音声ボタンの表示を切り替え
        if (isGrammarMode) {
            // 文法問題モード: 使用場面フィルターを非表示、文法類型フィルターを同じ位置に表示
            sceneFilterContainerEl.style.display = 'none';
            grammarTypeFilterContainerEl.style.display = 'flex';
            playAudioBtn.classList.add('hidden');
        } else {
            // 通常モード: 使用場面フィルターを表示、文法類型フィルターを非表示
            sceneFilterContainerEl.style.display = 'flex';
            grammarTypeFilterContainerEl.style.display = 'none';
            playAudioBtn.classList.remove('hidden');
        }

        if (DB.length === 0) {
            englishTextEl.textContent = '選択された条件に該当するデータがありません。';
            showMessage('データが見つかりませんでした。', 'danger');
            progressIndicatorEl.textContent = '0/0';
            toggleLearnedBtn.classList.add('hidden');
            englishTextEl.classList.remove('italic', 'text-gray-400', 'blur-strong');
            translationCardEl.classList.add('hidden');
            return;
        }

        currentSentenceIndex = 0;
        loadSentence(currentSentenceIndex);
    }

    /**
     * モードを切り替える
     */
    function changeMode(mode) {
        currentMode = parseInt(mode, 10);
        localStorage.setItem('lastLearningMode', currentMode);
        modeSelectorEl.value = currentMode;
        
        // 【修正①】モード切り替え時の和訳表示状態をリセット
        if (currentMode !== 4) {
            isTranslationVisible = false;
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none';
            japaneseTextEl.textContent = ''; 
        }
        
        grammarTranslationCardEl.classList.add('hidden'); 
        grammarJapaneseTextEl.textContent = ''; 
        englishTextEl.classList.remove('blur-strong', 'italic', 'text-gray-400');
        
        if (currentMode === 1) { 
            toggleTranslationBtn.textContent = '和訳を表示';
        } else if (currentMode === 2) { 
            toggleTranslationBtn.textContent = '英文・和訳を表示';
        }

        mainContentEl.classList.remove('grammar-layout-answered');
        applyAllFilters();
    }

    /**
     * 現在の文のデータをUIに読み込む
     */
    function loadSentence(index) {
        if (DB.length === 0) {
            progressIndicatorEl.textContent = '0/0';
            return;
        }

        currentSentenceIndex = (index + DB.length) % DB.length;
        const data = DB[currentSentenceIndex];

        // 進捗状況を更新
        progressIndicatorEl.textContent = `${currentSentenceIndex + 1}/${DB.length}`;

        // 英文/和訳表示エリアの切り替えとデータ設定
        if (currentMode === 4) { // 文法問題モード
            mainContentEl.classList.remove('grammar-layout-answered');
            grammarTargetSentenceEl.textContent = data.grammar_question; // 空欄あり英文
            // 文法問題のUIリセット
            resetGrammarUI(data);
            
            // 【修正】通常の和訳カードを確実に非表示にする
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none'; // CSSでも確実に非表示
            
            // 【修正①】文法問題モードでは最初から和訳を表示
            grammarJapaneseTextEl.textContent = data.ja;
            grammarTranslationCardEl.classList.remove('hidden'); 
            isTranslationVisible = true;
            
            japaneseTextEl.textContent = '';
            
            // 文法UIを表示し、通常英文UIを非表示
            englishDisplayCard.classList.add('hidden');
            grammarQuestionUiEl.classList.remove('hidden');

        } else { // 英文先行(1) または 音声先行(2)
            // 英文表示のセット
            englishTextEl.textContent = data.en;

            // モードに応じた英文表示の調整 (ぼかし)
            if (currentMode === 1) { 
                englishTextEl.classList.remove('blur-strong', 'italic', 'text-gray-400');
                toggleTranslationBtn.textContent = '和訳を表示';
            } else if (currentMode === 2) { 
                englishTextEl.classList.add('blur-strong'); 
                englishTextEl.classList.remove('italic', 'text-gray-400');
                toggleTranslationBtn.textContent = '英文・和訳を表示';
            }

            // 【修正①】非文法モードでは和訳カードを初期状態で完全非表示
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none';
            grammarTranslationCardEl.classList.add('hidden'); 
            isTranslationVisible = false;
            japaneseTextEl.textContent = '';
            
            // 文法UIは非表示に
            englishDisplayCard.classList.remove('hidden');
            grammarQuestionUiEl.classList.add('hidden');
        }

        // 学習済みステータスを更新
        updateLearnedStatusUI(data.isLearned);
    }

    /**
     * 前後へ移動する
     */
    function navigate(direction) {
        loadSentence(currentSentenceIndex + direction);
        // 【修正①】移動時は和訳を非表示にリセット（文法問題以外）
        if (currentMode !== 4) {
            isTranslationVisible = false;
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none';
            japaneseTextEl.textContent = ''; 
        }
        grammarTranslationCardEl.classList.add('hidden'); 
        grammarJapaneseTextEl.textContent = '';

        // モードに応じた英文表示の調整 (再度のマスキング)
        if (currentMode === 1) { 
            englishTextEl.classList.remove('blur-strong', 'italic', 'text-gray-400');
        } else if (currentMode === 2) { 
            englishTextEl.classList.add('blur-strong'); 
            englishTextEl.classList.remove('italic', 'text-gray-400');
        }

        // 文法モードの場合は、UIをリセット
        if (currentMode === 4) {
             resetGrammarUI(DB[currentSentenceIndex]);
        }
        
        toggleTranslationBtn.textContent = currentMode === 1 ? '和訳を表示' : '英文・和訳を表示';
    }


    // --- 学習済みステータス管理 (省略) ---
    function loadLearnedStatus() {
        const json = localStorage.getItem(LEARNED_STATUS_KEY);
        return json ? JSON.parse(json) : {};
    }

    function saveLearnedStatus(statusMap) {
        localStorage.setItem(LEARNED_STATUS_KEY, JSON.stringify(statusMap));
    }

    function toggleLearnedStatus() {
        if (DB.length === 0) return;

        const currentId = DB[currentSentenceIndex].id;
        let learnedStatusMap = loadLearnedStatus();
        const isCurrentlyLearned = !!learnedStatusMap[currentId];

        if (isCurrentlyLearned) {
            delete learnedStatusMap[currentId];
            DB[currentSentenceIndex].isLearned = false;
            showMessage('未学習に戻しました。', 'gray');
        } else {
            learnedStatusMap[currentId] = true;
            DB[currentSentenceIndex].isLearned = true;
            showMessage('「覚えた」としてマークしました！', 'secondary');
        }
        saveLearnedStatus(learnedStatusMap);
        updateLearnedStatusUI(DB[currentSentenceIndex].isLearned);
        
        if (filterModeSelectorEl.value !== 'ALL') {
            applyAllFilters();
        }
    }

    function updateLearnedStatusUI(isLearned) {
        if (isLearned) {
            toggleLearnedBtn.classList.remove('bg-secondary', 'hover:bg-emerald-600');
            toggleLearnedBtn.classList.add('bg-red-500', 'hover:bg-red-600');
            toggleLearnedBtn.textContent = '未学習に戻す';
        } else {
            toggleLearnedBtn.classList.add('bg-secondary', 'hover:bg-emerald-600');
            toggleLearnedBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            toggleLearnedBtn.textContent = '✓ 覚えた';
        }
    }


    // --- 和訳・音声再生 (省略) ---

    function toggleTranslation() {
        if (currentMode === 4) {
            return; 
        }

        isTranslationVisible = !isTranslationVisible;
        
        // 【修正①】和訳表示時はdisplayも変更
        if (isTranslationVisible) {
            translationCardEl.classList.remove('hidden');
            translationCardEl.style.display = 'flex'; // フレックス表示に
            japaneseTextEl.textContent = DB[currentSentenceIndex].ja;
            toggleTranslationBtn.textContent = '和訳を非表示';
            
            if (currentMode === 2) {
                englishTextEl.classList.remove('blur-strong');
                englishTextEl.classList.remove('italic', 'text-gray-400');
            }

        } else {
            translationCardEl.classList.add('hidden');
            translationCardEl.style.display = 'none'; // 完全非表示
            japaneseTextEl.textContent = ''; 
            toggleTranslationBtn.textContent = currentMode === 1 ? '和訳を表示' : '英文・和訳を表示'; 
            
            if (currentMode === 2) {
                englishTextEl.classList.add('blur-strong');
            }
        }
    }

    function playAudio() {
        const data = DB[currentSentenceIndex];
        const config = CATEGORY_MAP[currentCategoryKey];
        if (!data || !config) return;

        const audioFileName = data.id + '.mp3';
        const audioPath = `./audio/${config.audioFolder}/${audioFileName}`;
        
        const audio = new Audio(audioPath);
        audio.play().catch(error => {
            console.error("音声再生エラー:", error, audioPath);
            showMessage('音声ファイルの再生に失敗しました。ファイルが存在しないか、ブラウザの制限です。', 'danger');
        });

        if (currentMode === 2 && englishTextEl.classList.contains('blur-strong')) {
             englishTextEl.classList.remove('blur-strong');
             englishTextEl.classList.add('italic', 'text-gray-400');
             showMessage('英文のぼかしを解除しました。', 'gray');
        }
    }


    // --- 文法問題モード関連 ---

    /**
     * 文法問題のUIをリセットする
     */
    function resetGrammarUI(data) {
        grammarQuestionTextEl.textContent = '(空欄に当てはまる語句を選んでください)'; 
        grammarAnswerExplanationEl.classList.add('hidden');
        mainContentEl.classList.remove('grammar-layout-answered');
        mainContentEl.classList.add('overflow-y-auto');
        
        // 【修正】通常の和訳カードを確実に非表示
        translationCardEl.classList.add('hidden');
        translationCardEl.style.display = 'none'; // CSSでも非表示
        grammarTranslationCardEl.classList.add('hidden'); 
        japaneseTextEl.textContent = '';
        grammarJapaneseTextEl.textContent = ''; 
        isTranslationVisible = false;

        const allLetters = ['A', 'B', 'C', 'D'];
        
        // 選択肢のテキスト設定とUIリセット
        allLetters.forEach(letter => {
            const buttonEl = document.getElementById(`choice-${letter}`);
            const choiceKey = 'grammar_choice_' + letter.toLowerCase();
            const choiceTextWithLetter = data[choiceKey];

            if (choiceTextWithLetter) {
                const choiceText = choiceTextWithLetter.substring(3).trim(); 
                buttonEl.textContent = choiceText;
                buttonEl.setAttribute('onclick', `checkGrammarAnswer('${letter}')`);
                buttonEl.disabled = false;
                buttonEl.classList.remove('bg-green-100', 'bg-red-100', 'border-green-500', 'border-red-500', 'selected', 'opacity-50', 'hidden');
                buttonEl.classList.add('bg-gray-100', 'border-gray-300');
            } else {
                buttonEl.classList.add('hidden');
            }
        });
    }


    /**
     * 文法問題の回答をチェックする
     */
    function checkGrammarAnswer(selectedLetter) {
        const data = DB[currentSentenceIndex];
        const correctChoiceWithLetter = data.grammar_answer; 
        const correctLetter = correctChoiceWithLetter.substring(0, 1); 
        
        const isCorrect = selectedLetter === correctLetter;

        grammarQuestionTextEl.textContent = '';

        // 回答選択肢のUIを更新
        const selectedButton = document.getElementById(`choice-${selectedLetter}`);
        const correctButton = document.getElementById(`choice-${correctLetter}`);

        // 全てのボタンを無効化
        document.querySelectorAll('#grammar-choices button').forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-50');
        });

        if (isCorrect) {
            // 正解の場合
            selectedButton.classList.remove('bg-gray-100', 'border-gray-300', 'bg-red-100', 'border-red-500');
            selectedButton.classList.add('bg-green-100', 'border-green-500');
        } else {
            // 不正解の場合
            selectedButton.classList.remove('bg-gray-100', 'border-gray-300');
            selectedButton.classList.add('bg-red-100', 'border-red-500');

            // 正解のボタンを緑色で表示
            if (correctButton) {
                correctButton.classList.remove('bg-gray-100', 'border-gray-300', 'opacity-50');
                correctButton.classList.add('bg-green-100', 'border-green-500');
                correctButton.disabled = true; 
            }
        }

        // 解説と和訳を表示
        grammarCorrectAnswerEl.textContent = correctChoiceWithLetter;
        grammarExplanationTextEl.textContent = data.grammar_explanation || '解説はありません。';
        grammarAnswerExplanationEl.classList.remove('hidden');

        // 和訳カードの表示（解答後）
        grammarJapaneseTextEl.textContent = data.ja; 
        grammarTranslationCardEl.classList.remove('hidden'); 
        isTranslationVisible = true; 

        // レイアウトを回答後スタイルに切り替え
        mainContentEl.classList.remove('overflow-y-auto');
        mainContentEl.classList.add('grammar-layout-answered');
    }

    /**
     * 文法類型でフィルタリングする
     */
    function filterByType(type) {
        currentGrammarType = type;
        applyAllFilters();
    }
    
    /**
     * 使用場面でフィルタリングする
     */
    function filterScenes(scene) {
        currentSceneFilter = scene;
        applyAllFilters();
    }


    // --- メッセージ表示 (省略) ---

    function clearMessage() {
        if (messageTimeoutId) {
            clearTimeout(messageTimeoutId);
        }
        messageBoxEl.classList.add('hidden');
        messageBoxEl.textContent = '';
    }

    function showMessage(text, type) {
        clearMessage();
        
        messageBoxEl.textContent = text;
        messageBoxEl.className = `text-center py-2 px-4 text-lg font-semibold rounded-lg shadow-sm mt-4`;
        
        let bgColor, textColor;
        switch (type) {
            case 'secondary': bgColor = 'bg-emerald-200'; textColor = 'text-emerald-800'; break; 
            case 'danger': bgColor = 'bg-red-200'; textColor = 'text-red-800'; break;
            case 'primary': bgColor = 'bg-indigo-200'; textColor = 'text-indigo-800'; break; 
            case 'gray': bgColor = 'bg-gray-200'; textColor = 'text-gray-800'; break;
            default: bgColor = 'bg-gray-200'; textColor = 'text-gray-800'; break;
        }
        messageBoxEl.classList.add(bgColor, textColor);
        messageBoxEl.classList.remove('hidden');

        messageTimeoutId = setTimeout(() => {
            messageBoxEl.classList.add('hidden');
        }, 3000);
    }
</script>
</body>
</html>